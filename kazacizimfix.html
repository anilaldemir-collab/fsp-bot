<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaza Yeri Ä°nceleme AracÄ± - Rapor DosyasÄ±</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS (Harita) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- React ve ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Lucide Icons (Global Paket) -->
    <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.min.js"></script>
    
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #f1f5f9; }
        canvas { touch-action: none; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .modal-overlay { background-color: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); }
        .help-step { display: flex; gap: 12px; margin-bottom: 20px; align-items: flex-start; }
        .help-icon { min-width: 40px; height: 40px; background: #e0f2fe; color: #0369a1; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .help-content h4 { font-weight: bold; color: #0f172a; margin-bottom: 4px; }
        .help-content p { font-size: 0.85rem; color: #475569; line-height: 1.4; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- Ä°KON BÄ°LEÅžENÄ° ---
        const Icon = ({ name, size = 16, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && window.lucide.icons && window.lucide.createElement && ref.current) {
                    const iconName = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                    const iconDef = window.lucide.icons[iconName];
                    if (iconDef) {
                        const svgElement = window.lucide.createElement(iconDef);
                        svgElement.setAttribute('width', size);
                        svgElement.setAttribute('height', size);
                        if (className) svgElement.setAttribute('class', className);
                        ref.current.innerHTML = '';
                        ref.current.appendChild(svgElement);
                    }
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-flex items-center justify-center" style={{ width: size, height: size }}></span>;
        };

        // --- YARDIMCI BÄ°LEÅžEN: BUTON ELEMENTÄ° (GLOBAL) ---
        const ButtonEl = ({onClick, icon, label, color="text-slate-700", bg="hover:bg-gray-50"}) => (
            <button onClick={onClick} className={`p-1 border rounded flex flex-col items-center justify-center ${bg}`}>
                <Icon name={icon} size={16} className={color}/>
                {label && <span className="text-[8px] mt-1">{label}</span>}
            </button>
        );

        // --- 3D ARAÃ‡ Ã‡Ä°ZÄ°M YARDIMCILARI ---
        const adjustColor = (color, amount) => {
            return '#' + color.replace(/^#/, '').replace(/../g, color => ('0'+Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2));
        }

        function roundRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
        }

        const draw3DCar = (ctx, w, h, color) => {
            ctx.shadowColor = 'rgba(0,0,0,0.4)'; ctx.shadowBlur = 15; ctx.shadowOffsetX = 5; ctx.shadowOffsetY = 5;
            ctx.fillStyle = color; roundRect(ctx, -w/2, -h/2, w, h, 8); ctx.fill();
            ctx.shadowColor = 'transparent'; ctx.shadowBlur = 0; ctx.shadowOffsetX = 0; ctx.shadowOffsetY = 0;
            const roofW = w * 0.85; const roofH = h * 0.5;
            ctx.fillStyle = '#94a3b8'; ctx.beginPath(); ctx.moveTo(-w/2 + 4, -h/2 + 10); ctx.lineTo(w/2 - 4, -h/2 + 10); ctx.lineTo(roofW/2, -roofH/2); ctx.lineTo(-roofW/2, -roofH/2); ctx.fill();
            ctx.beginPath(); ctx.moveTo(-roofW/2, roofH/2); ctx.lineTo(roofW/2, roofH/2); ctx.lineTo(w/2 - 4, h/2 - 10); ctx.lineTo(-w/2 + 4, h/2 - 10); ctx.fill();
            try { ctx.fillStyle = adjustColor(color, 40); } catch(e) { ctx.fillStyle = color; } roundRect(ctx, -roofW/2, -roofH/2, roofW, roofH, 5); ctx.fill(); ctx.strokeStyle = 'rgba(0,0,0,0.1)'; ctx.lineWidth = 1; ctx.stroke();
            ctx.fillStyle = '#fef08a'; ctx.beginPath(); ctx.arc(-w/2 + 6, -h/2 + 2, 3, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(w/2 - 6, -h/2 + 2, 3, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#ef4444'; ctx.fillRect(-w/2 + 4, h/2 - 3, 8, 3); ctx.fillRect(w/2 - 12, h/2 - 3, 8, 3);
        };

        const draw3DBus = (ctx, w, h, color) => {
            ctx.shadowColor = 'rgba(0,0,0,0.4)'; ctx.shadowBlur = 15; ctx.shadowOffsetX = 5; ctx.shadowOffsetY = 5;
            ctx.fillStyle = color; roundRect(ctx, -w/2, -h/2, w, h, 6); ctx.fill(); ctx.shadowColor = 'transparent';
            ctx.fillStyle = '#94a3b8'; ctx.fillRect(-w/2 + 2, -h/2 + 2, w - 4, h * 0.15);
            try { ctx.fillStyle = adjustColor(color, 20); } catch(e) { ctx.fillStyle = '#e2e8f0'; } roundRect(ctx, -w/2 + 3, -h/2 + h*0.15 + 2, w - 6, h * 0.8 - 4, 2); ctx.fill();
            ctx.fillStyle = 'rgba(0,0,0,0.1)'; ctx.beginPath(); ctx.arc(0, -h/4, 6, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(0, h/4, 6, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#333'; ctx.fillRect(-w/2 - 2, -h/2 + 10, 2, 8); ctx.fillRect(w/2, -h/2 + 10, 2, 8);
        };

        const draw3DTruck = (ctx, w, h, color) => {
            const cabH = h * 0.25; ctx.shadowColor = 'rgba(0,0,0,0.4)'; ctx.shadowBlur = 10; ctx.shadowOffsetX = 3; ctx.shadowOffsetY = 3;
            ctx.fillStyle = color; roundRect(ctx, -w/2, -h/2, w, cabH, 4); ctx.fill();
            ctx.fillStyle = '#94a3b8'; ctx.fillRect(-w/2 + 3, -h/2 + 5, w - 6, 10);
            const trailerH = h * 0.7; const trailerW = w + 2; const gap = h * 0.05;
            ctx.fillStyle = '#e2e8f0'; roundRect(ctx, -trailerW/2, -h/2 + cabH + gap, trailerW, trailerH, 2); ctx.fill();
            ctx.strokeStyle = '#cbd5e1'; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(0, -h/2 + cabH + gap); ctx.lineTo(0, h/2); ctx.stroke(); ctx.beginPath(); ctx.moveTo(-trailerW/2, 0); ctx.lineTo(trailerW/2, 0); ctx.stroke();
            ctx.shadowColor = 'transparent';
        };

        // --- ANA UYGULAMA ---
        const MapAccidentSketch = () => {
            const savedData = window.__ACCIDENT_DATA__ || {};
            const isViewOnly = savedData.isViewOnly || false;

            const [coords, setCoords] = useState(savedData.coords || { lat: 41.077139, lng: 29.030945 });
            const [inputCoords, setInputCoords] = useState({ lat: String(coords.lat), lng: String(coords.lng) });
            const [mapLoaded, setMapLoaded] = useState(false);
            const [isMapLocked, setIsMapLocked] = useState(false);
            const mapInstanceRef = useRef(null);
            const mapContainerRef = useRef(null);
            const canvasRef = useRef(null);
            const markerRef = useRef(null);
            const mousePosRef = useRef(null); 
            
            const [elements, setElements] = useState(savedData.elements || []);
            const [selectedId, setSelectedId] = useState(null);
            const [mode, setMode] = useState('pan'); 
            const [drawingColor, setDrawingColor] = useState('#ef4444');
            const [drawingWidth, setDrawingWidth] = useState(5);
            const [dragStart, setDragStart] = useState(null);
            const [action, setAction] = useState('none');
            const [screenshotMode, setScreenshotMode] = useState(false);
            const [openMenu, setOpenMenu] = useState('vehicles'); 
            const [courierImage, setCourierImage] = useState(null);
            const [environment, setEnvironment] = useState(savedData.environment || { lighting: '', weather: '' });
            
            const [activeRouteId, setActiveRouteId] = useState(null);
            const [canvasSize, setCanvasSize] = useState({ width: window.innerWidth, height: window.innerHeight });

            // Sokak GÃ¶rÃ¼nÃ¼mÃ¼ iÃ§in State'ler
            const [streetViewMode, setStreetViewMode] = useState(savedData.streetViewMode || 'image'); 
            const [apiKey, setApiKey] = useState(savedData.apiKey || localStorage.getItem('google_maps_key') || '');
            const [tempKey, setTempKey] = useState('');

            // Analiz ve YardÄ±m Raporu State'leri
            const [analysisReport, setAnalysisReport] = useState(null);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [showHelp, setShowHelp] = useState(false);

            // --- Ä°LK KURULUM (HARÄ°TAYI BAÅžLATMAK Ä°Ã‡Ä°N KRÄ°TÄ°K) ---
            useEffect(() => {
                setMapLoaded(true);
                const img = new Image();
                img.src = 'Screenshot_2025-01-04_at_22.24.03-removebg-preview.png';
                img.onload = () => setCourierImage(img);
            }, []);

            // --- YARDIMCI BÄ°LEÅžEN: MENÃœ Ã–ÄžESÄ° (Ä°Ã‡) ---
            const MenuItem = ({ id, title, icon: IconName, children }) => (
                <div className="border-b last:border-0">
                    <button onClick={() => setOpenMenu(openMenu === id ? null : id)} className="w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 transition text-left">
                        <div className="flex items-center gap-2 font-semibold text-sm text-slate-700"><Icon name={IconName} size={16}/> {title}</div>
                        {openMenu === id ? <Icon name="chevron-down" size={14}/> : <Icon name="chevron-right" size={14}/>}
                    </button>
                    {openMenu === id && <div className="p-2 bg-white grid grid-cols-4 gap-2 animate-in slide-in-from-top-1">{children}</div>}
                </div>
            );

            const handleZoomIn = () => {
                if (mapInstanceRef.current) mapInstanceRef.current.zoomIn();
            };
            const handleZoomOut = () => {
                if (mapInstanceRef.current) mapInstanceRef.current.zoomOut();
            };

            const saveApiKey = () => {
                if(tempKey.trim()) {
                    setApiKey(tempKey.trim());
                    localStorage.setItem('google_maps_key', tempKey.trim());
                }
            };

            const clearApiKey = () => {
                setApiKey('');
                localStorage.removeItem('google_maps_key');
            };

            // --- GEOMETRÄ°K HESAPLAMA YARDIMCILARI ---
            const toRad = (deg) => deg * Math.PI / 180;
            const toDeg = (rad) => rad * 180 / Math.PI;

            const calculateBearing = (lat1, lon1, lat2, lon2) => {
                const y = Math.sin(toRad(lon2 - lon1)) * Math.cos(toRad(lat2));
                const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
                        Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(toRad(lon2 - lon1));
                const brng = toDeg(Math.atan2(y, x));
                return (brng + 360) % 360;
            };

            const angleDifference = (a1, a2) => {
                let diff = Math.abs(a1 - a2) % 360;
                return diff > 180 ? 360 - diff : diff;
            };

            const getDirectionFromRotation = (rotation) => {
                const normalized = (rotation % 360 + 360) % 360;
                if (normalized >= 315 || normalized < 45) return "Kuzey";
                if (normalized >= 45 && normalized < 135) return "DoÄŸu";
                if (normalized >= 135 && normalized < 225) return "GÃ¼ney";
                if (normalized >= 225 && normalized < 315) return "BatÄ±";
                return "Bilinmeyen";
            };

            const determineCollisionType = (v1, v2, crashPoint = null) => {
                if (crashPoint) {
                    const angle1 = calculateBearing(v1.lat, v1.lng, crashPoint.lat, crashPoint.lng);
                    const angle2 = calculateBearing(v2.lat, v2.lng, crashPoint.lat, crashPoint.lng);
                    const diff = angleDifference(angle1, angle2);
                    if (diff >= 150) return "Kafa kafaya Ã§arpÄ±ÅŸma (Burun buruna)";
                    if (diff >= 45 && diff < 150) return "Yandan/Dik aÃ§Ä±lÄ± Ã§arpÄ±ÅŸma";
                    if (diff < 45) return "Arkadan Ã§arpma veya Yanal SÃ¼rtÃ¼nme";
                }
                const diff = Math.abs(v1.rotation - v2.rotation) % 360;
                const normalizedDiff = diff > 180 ? 360 - diff : diff;
                if (normalizedDiff < 45) return "Arkadan Ã§arpma (Tahmini)";
                if (normalizedDiff > 135) return "Kafa kafaya Ã§arpÄ±ÅŸma (Tahmini)";
                return "Yandan/Dik aÃ§Ä±lÄ± Ã§arpÄ±ÅŸma (Tahmini)";
            };

            const getForwardVector = (rotation) => {
                const rad = (rotation * Math.PI) / 180;
                return { x: Math.sin(rad), y: Math.cos(rad) }; 
            };

            const simulateNewsData = (roadName, riskFactors) => {
                let baseCount = 0;
                if (roadName.includes("Caddesi") || roadName.includes("BulvarÄ±")) baseCount += 5;
                if (roadName.includes("Yolu") || roadName.includes("Otoyolu")) baseCount += 10;
                if (riskFactors.includes("TRAFÄ°K IÅžIKLARI")) baseCount += 3;
                const total = Math.max(0, baseCount + Math.floor(Math.random() * 5) - 2);
                const moto = Math.round(total * 0.3);
                const car = total - moto;
                return { total, moto, car };
            };

            // --- ANALÄ°Z MOTORU ---
            const generateAccidentReport = async () => {
                setIsAnalyzing(true);
                setAnalysisReport(null);

                let addressInfo = "Bilinmeyen Konum";
                let roadAttributes = [];
                let newsData = null;
                let waysData = []; 

                try {
                    const overpassQuery = `[out:json][timeout:10];(way(around:50,${coords.lat},${coords.lng})["highway"];node(around:50,${coords.lat},${coords.lng})["highway"="traffic_signals"];);out geom;`;
                    const encodedOverpassQuery = encodeURIComponent(overpassQuery);

                    const [nominatimRes, overpassRes] = await Promise.all([
                        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords.lat}&lon=${coords.lng}&zoom=18&addressdetails=1`, {
                            headers: { 'User-Agent': 'AccidentSketchApp/1.0' }
                        }),
                        fetch(`https://overpass-api.de/api/interpreter?data=${encodedOverpassQuery}`)
                    ]);

                    if (!nominatimRes.ok) throw new Error("Nominatim API HatasÄ±");
                    const addrData = await nominatimRes.json();
                    addressInfo = (addrData.address?.road || "") + ", " + (addrData.address?.suburb || addrData.address?.neighbourhood || "");
                    if(addressInfo === ", ") addressInfo = "Belirlenemeyen Cadde/Sokak";

                    try {
                        if (!overpassRes.ok) throw new Error("Overpass API HatasÄ±");
                        const roadData = await overpassRes.json();
                        
                        if (roadData.elements) {
                            waysData = roadData.elements.filter(e => e.type === 'way');
                            const nodes = roadData.elements.filter(e => e.type === 'node');

                            const isOneWay = waysData.some(w => w.tags?.oneway === 'yes' || w.tags?.oneway === '-1');
                            if (isOneWay) roadAttributes.push("âš ï¸ Harita verilerine gÃ¶re olay yerindeki yollardan en az biri **TEK YÃ–NLÃœ**dÃ¼r.");

                            const hasSignals = nodes.some(n => n.tags?.highway === 'traffic_signals') || waysData.some(w => w.tags?.highway === 'traffic_signals');
                            if (hasSignals) roadAttributes.push("ðŸš¦ BÃ¶lgede **TRAFÄ°K IÅžIKLARI (Sinyalizasyon)** bulunduÄŸu tespit edilmiÅŸtir.");

                            const speedLimit = waysData.find(w => w.tags?.maxspeed)?.tags?.maxspeed;
                            if (speedLimit) roadAttributes.push(`â›” BÃ¶lgede hÄ±z limiti tabelasÄ± (**${speedLimit} km/s**) kaydÄ± bulunmaktadÄ±r.`);
                        }
                    } catch (opError) {
                        console.warn("Yol verileri alÄ±namadÄ±:", opError);
                    }

                    newsData = simulateNewsData(addrData.address?.road || "", roadAttributes.join(" "));

                } catch (error) {
                    console.error("Veri alÄ±namadÄ±:", error);
                    addressInfo = "Konum bilgisi alÄ±namadÄ± (AÄŸ HatasÄ±)";
                }

                const vehicles = elements.filter(el => ['car', 'bus', 'truck', 'moto', 'bicycle'].includes(el.type));
                const signs = elements.filter(el => ['traffic_sign', 'signal'].includes(el.type));
                const defects = elements.filter(el => el.type === 'road_defect');
                const crashPoints = elements.filter(el => el.type === 'sign' && el.subType === 'crash_point');
                const routes = elements.filter(el => el.type === 'route');
                
                let report = [];
                let faultAssessment = []; 
                let recommendations = [];

                report.push(`ðŸ“„ **TAHMÄ°NÄ° KAZA SENARYOSU**`);
                report.push(`ðŸ“ **Olay Yeri:** ${addressInfo}`);
                report.push(`ðŸ•’ **Zaman/Ã‡evre:** ${environment.lighting || 'BelirtilmemiÅŸ'} aydÄ±nlatma, ${environment.weather || 'BelirtilmemiÅŸ'} hava koÅŸullarÄ±.`);
                
                if (roadAttributes.length > 0) {
                    report.push("");
                    report.push(`ðŸ›£ï¸ **Yol ve Trafik AltyapÄ±sÄ±:**`);
                    roadAttributes.forEach(attr => report.push(attr));
                }

                report.push("------------------------------------------------");

                if (vehicles.length === 0) {
                    report.push("âš ï¸ Krokide herhangi bir araÃ§ bulunamadÄ±.");
                } else {
                    // ARAÃ‡ ANALÄ°ZÄ°
                    vehicles.forEach((v, index) => {
                        const vName = `${v.color === '#ef4444' ? 'KÄ±rmÄ±zÄ±' : v.color === '#3b82f6' ? 'Mavi' : 'Renkli'} ${getVehicleName(v.type)}`;
                        
                        // ROTA VARSA YÃ–NÃœ ROTADAN AL, YOKSA ARAÃ‡TAN
                        let movementBearing = v.rotation;
                        let hasRoute = false;

                        const associatedRoute = routes.find(r => {
                            if (r.points && r.points.length > 1) {
                                const startPoint = r.points[0];
                                const dist = Math.hypot(startPoint.lat - v.lat, startPoint.lng - v.lng);
                                return dist < 0.0002;
                            }
                            return false;
                        });

                        if (associatedRoute) {
                            hasRoute = true;
                            movementBearing = calculateBearing(
                                associatedRoute.points[0].lat, associatedRoute.points[0].lng,
                                associatedRoute.points[1].lat, associatedRoute.points[1].lng
                            );
                        }

                        const direction = getDirectionFromRotation(movementBearing);
                        let movementText = `**AraÃ§ ${index + 1} (${vName})**: ${direction} yÃ¶nÃ¼ne doÄŸru ${hasRoute ? '(Ã§izilen rotaya gÃ¶re) ' : ''}seyir halindedir.`;

                        // GÃœÃ‡LENDÄ°RÄ°LMÄ°Åž TERS YÃ–N ANALÄ°ZÄ° (ROTA DESTEKLÄ°)
                        let isWrongWay = false;
                        if (waysData.length > 0) {
                            let minDistance = Infinity;
                            let closestWay = null;
                            let closestSegmentBearing = 0;

                            waysData.forEach(way => {
                                const isOneway = way.tags?.oneway === 'yes' || way.tags?.oneway === '-1';
                                if(isOneway && way.geometry) {
                                    for(let i=0; i < way.geometry.length - 1; i++) {
                                        const p1 = way.geometry[i];
                                        const p2 = way.geometry[i+1];
                                        const midLat = (p1.lat + p2.lat)/2;
                                        const midLon = (p1.lon + p2.lon)/2;
                                        const dist = Math.hypot(midLat - v.lat, midLon - v.lng);
                                        
                                        if(dist < minDistance) {
                                            minDistance = dist;
                                            closestWay = way;
                                            let segmentBearing = calculateBearing(p1.lat, p1.lon, p2.lat, p2.lon);
                                            if (way.tags?.oneway === '-1') {
                                                segmentBearing = (segmentBearing + 180) % 360;
                                            }
                                            closestSegmentBearing = segmentBearing;
                                        }
                                    }
                                }
                            });

                            if (closestWay && minDistance < 0.00025) { 
                                const angleDiff = angleDifference(movementBearing, closestSegmentBearing);
                                if (angleDiff > 120) {
                                    isWrongWay = true;
                                    movementText += ` âš ï¸ **DÄ°KKAT:** Harita verilerine gÃ¶re araÃ§ **TEK YÃ–NLÃœ** yolda **TERS Ä°STÄ°KAMETTE** gÃ¶rÃ¼nmektedir!`;
                                    faultAssessment.push(`â›” **AraÃ§ ${index+1} (Ters YÃ¶n):** Harita verilerine gÃ¶re tek yÃ¶nlÃ¼ yola ters istikametten girdiÄŸi tespit edilmiÅŸtir. Bu durum, **Ters YÃ¶n Ä°hlali** (KTK 84/1-h) ihtimalini kuvvetlendirmektedir.`);
                                    if(!recommendations.some(r => r.includes("kapan"))) recommendations.push("Ters yÃ¶n ihlallerini Ã¶nlemek iÃ§in kapan veya daha belirgin 'Girilmez' levhalarÄ± konulmalÄ±dÄ±r.");
                                }
                            }
                        }
                        
                        const nearbySign = signs.find(s => {
                            const dist = Math.hypot(s.lat - v.lat, s.lng - v.lng);
                            return dist < 0.00020; 
                        });

                        const nearbyDefect = defects.find(d => {
                            const dist = Math.hypot(d.lat - v.lat, d.lng - v.lng);
                            return dist < 0.00015;
                        });

                        if (nearbySign) {
                            if (nearbySign.subType === 'priority_stop') {
                                movementText += ` SÃ¼rÃ¼cÃ¼ "DUR" levhasÄ± bÃ¶lgesindedir.`;
                                faultAssessment.push(`ðŸ”´ **AraÃ§ ${index+1}**, DUR levhasÄ±na uymayarak geÃ§iÅŸ hakkÄ± ihlali yapmÄ±ÅŸ olabilir (KTK 57/1-a).`);
                                if(!recommendations.some(r => r.includes("tam duruÅŸ"))) recommendations.push("SÃ¼rÃ¼cÃ¼lerin 'DUR' levhasÄ± bulunan kavÅŸaklarda tekerlekleri tam duracak ÅŸekilde durmalarÄ± ve yolu kontrol ettikten sonra geÃ§iÅŸ yapmalarÄ± gerekmektedir.");
                            }
                            if (nearbySign.subType === 'red') {
                                movementText += ` KÄ±rmÄ±zÄ± Ä±ÅŸÄ±k bÃ¶lgesindedir.`;
                                faultAssessment.push(`ðŸ”´ **AraÃ§ ${index+1}**, KÄ±rmÄ±zÄ± Ä±ÅŸÄ±k ihlali yapmÄ±ÅŸ olabilir (KTK 47/1-b).`);
                                if(!recommendations.some(r => r.includes("Ä±ÅŸÄ±k"))) recommendations.push("SÃ¼rÃ¼cÃ¼lerin trafik Ä±ÅŸÄ±klarÄ±na yaklaÅŸÄ±rken hÄ±zlarÄ±nÄ± azaltmalarÄ±, sarÄ± Ä±ÅŸÄ±kta geÃ§mek yerine durmaya hazÄ±rlanmalarÄ± hayati Ã¶nem taÅŸÄ±r.");
                            }
                            if (nearbySign.subType === 'no_entry' && !isWrongWay) { 
                                movementText += ` "Girilmez" levhasÄ± bÃ¶lgesindedir.`;
                                faultAssessment.push(`ðŸ”´ **AraÃ§ ${index+1}**, "Girilmez" levhasÄ±na raÄŸmen yola girmiÅŸ gÃ¶rÃ¼nmektedir (Ters YÃ¶n Ä°hlali).`);
                            }
                            if (nearbySign.subType === 'priority_yield') {
                                faultAssessment.push(`âš ï¸ **AraÃ§ ${index+1}**, "Yol Ver" levhasÄ±na raÄŸmen geÃ§iÅŸ Ã¼stÃ¼nlÃ¼ÄŸÃ¼ne uymamÄ±ÅŸ olabilir.`);
                                if(!recommendations.some(r => r.includes("tali yol"))) recommendations.push("Tali yoldan ana yola Ã§Ä±kan sÃ¼rÃ¼cÃ¼lerin, ana yoldaki araÃ§ akÄ±ÅŸÄ±nÄ± riske atmayacak ÅŸekilde beklemeleri gerekmektedir.");
                            }
                            if (nearbySign.subType === 'danger_pedestrian') {
                                movementText += ` Yaya geÃ§idi bÃ¶lgesindedir.`;
                                faultAssessment.push(`âš ï¸ **AraÃ§ ${index+1}**, Yaya geÃ§idinde durmayarak yayalarÄ±n geÃ§iÅŸ hakkÄ±nÄ± ihlal etmiÅŸ olabilir (KTK 74).`);
                                if(!recommendations.some(r => r.includes("yaya"))) recommendations.push("SÃ¼rÃ¼cÃ¼lerin yaya geÃ§itlerine yaklaÅŸÄ±rken hÄ±zlarÄ±nÄ± mutlak suretle dÃ¼ÅŸÃ¼rmeleri ve yayalara ilk geÃ§iÅŸ hakkÄ±nÄ± vermeleri yasal zorunluluktur.");
                            }
                        }

                        if(nearbyDefect) {
                            if(nearbyDefect.subType === 'pothole') {
                                movementText += ` Yol Ã¼zerinde Ã§ukur/bozuk zemin mevcuttur.`;
                                faultAssessment.push(`â„¹ï¸ **AraÃ§ ${index+1}**, Yol bozukluÄŸundan kaÃ§arken ÅŸerit ihlali yapmÄ±ÅŸ veya direksiyon hakimiyetini kaybetmiÅŸ olabilir.`);
                                if(!recommendations.some(r => r.includes("hakimiyet"))) recommendations.push("SÃ¼rÃ¼cÃ¼lerin yol yÃ¼zeyindeki bozukluklarÄ± fark ettiklerinde ani direksiyon kÄ±rmaktan kaÃ§Ä±nmalarÄ± ve hÄ±zlarÄ±nÄ± yol ÅŸartlarÄ±na gÃ¶re ayarlamalarÄ± gerekir.");
                            }
                            if(nearbyDefect.subType === 'slippery') {
                                movementText += ` Kaygan zemin bÃ¶lgesindedir.`;
                                faultAssessment.push(`â„¹ï¸ **AraÃ§ ${index+1}**, Kaygan zeminde hÄ±zÄ±nÄ± azaltmayarak kontrolÃ¼ kaybetmiÅŸ olabilir.`);
                                if(!recommendations.some(r => r.includes("takip"))) recommendations.push("Kaygan zeminlerde takip mesafesinin normalin en az iki katÄ±na Ã§Ä±karÄ±lmasÄ± ve ani frenlemeden kaÃ§Ä±nÄ±lmasÄ± gerekmektedir.");
                            }
                        }
                        
                        report.push(movementText);
                    });

                    report.push(""); 

                    if (vehicles.length >= 2) {
                        let v1 = vehicles[0];
                        let v2 = vehicles[1]; 
                        
                        const crashPoint = crashPoints.length > 0 ? crashPoints[0] : null;
                        
                        const collisionType = determineCollisionType(v1, v2, crashPoint);
                        const v1Name = `AraÃ§ 1 (${v1.color === '#ef4444' ? 'KÄ±rmÄ±zÄ±' : 'Mavi'} ${getVehicleName(v1.type)})`;
                        const v2Name = `AraÃ§ 2 (${v2.color === '#ef4444' ? 'KÄ±rmÄ±zÄ±' : 'Mavi'} ${getVehicleName(v2.type)})`;

                        report.push(`ðŸ’¥ **OluÅŸ Åžekli Tahmini:**`);
                        if (crashPoint) report.push(`Analiz, iÅŸaretlenen "Ã‡arpÄ±ÅŸma NoktasÄ±" (Crash Point) baz alÄ±narak yapÄ±lmÄ±ÅŸtÄ±r.`);

                        if (collisionType.includes("Arkadan")) {
                            report.push(`AraÃ§larÄ±n Ã§arpÄ±ÅŸma noktasÄ±na aynÄ± istikametten yaklaÅŸtÄ±ÄŸÄ± tespit edilmiÅŸtir. Bu durum **${collisionType}** olduÄŸunu gÃ¶stermektedir.`);
                            faultAssessment.push(`âš ï¸ **Takip Mesafesi:** Arkadan gelen araÃ§, Ã¶nÃ¼ndeki aracÄ± yeterli mesafeden takip etmeyerek (KTK 56/1-c) asli kusurlu durumunda olabilir.`);
                            if(!recommendations.some(r => r.includes("hÄ±zÄ±n yarÄ±sÄ±"))) recommendations.push("SÃ¼rÃ¼cÃ¼lerin Ã¶nlerindeki araÃ§la aralarÄ±nda, hÄ±zlarÄ±nÄ±n en az yarÄ±sÄ± kadar (Ã¶rneÄŸin 90 km/s ile giderken 45 metre) gÃ¼venli takip mesafesi bÄ±rakmalarÄ± gerekmektedir.");

                        } else if (collisionType.includes("Kafa kafaya")) {
                            report.push(`AraÃ§larÄ±n Ã§arpÄ±ÅŸma noktasÄ±na birbirlerine zÄ±t (karÅŸÄ±t) yÃ¶nlerden yaklaÅŸtÄ±ÄŸÄ± tespit edilmiÅŸtir. Bu durum **${collisionType}** olduÄŸunu iÅŸaret eder.`);
                            faultAssessment.push(`âš ï¸ **Åžerit Ä°hlali:** Kendi ÅŸeridini terk eden, hatalÄ± sollama yapan veya ters yÃ¶ne giren araÃ§ Asli Kusurlu sayÄ±lacaktÄ±r (KTK 84/1-c).`);
                            if(!recommendations.some(r => r.includes("sollama"))) recommendations.push("SÃ¼rÃ¼cÃ¼lerin gÃ¶rÃ¼ÅŸ mesafesinin yetersiz olduÄŸu viraj ve tepe Ã¼stÃ¼ gibi noktalarda kesinlikle sollama yapmamalarÄ± ve kendi ÅŸeritlerini terk etmemeleri gerekmektedir.");

                        } else {
                            // Yandan Ã‡arpÄ±ÅŸma
                            report.push(`AraÃ§larÄ±n Ã§arpÄ±ÅŸma noktasÄ±na farklÄ± aÃ§Ä±lardan (kesiÅŸerek) yaklaÅŸtÄ±ÄŸÄ± tespit edilmiÅŸtir. Bu durum **${collisionType}** olduÄŸunu gÃ¶stermektedir.`);
                            const hasSignals = signs.length > 0 || roadAttributes.some(attr => attr.includes("TRAFÄ°K IÅžIKLARI"));
                            if (!hasSignals) {
                                faultAssessment.push(`âš ï¸ **KontrolsÃ¼z KavÅŸak:** Levha veya Ä±ÅŸÄ±k bulunmayan kavÅŸaklarda, saÄŸdan gelen araca yol verilmemesi (KTK 57/1-c) muhtemel kaza sebebidir.`);
                                if(!recommendations.some(r => r.includes("kavÅŸak kontrolÃ¼"))) recommendations.push("SÃ¼rÃ¼cÃ¼lerin kavÅŸaklara yaklaÅŸÄ±rken, geÃ§iÅŸ Ã¶nceliÄŸi kendilerinde olsa bile hÄ±zlarÄ±nÄ± azaltmalarÄ± ve diÄŸer araÃ§larÄ±n durabilem ihtimalini gÃ¶zetmeleri (Defansif SÃ¼rÃ¼ÅŸ) Ã¶nemlidir.");
                            }
                        }
                    }
                }

                // GENEL Ã–NERÄ°LER
                if(environment.weather === 'YaÄŸmurlu' || environment.weather === 'KarlÄ±') {
                    recommendations.push("YaÄŸÄ±ÅŸlÄ± havalarda lastik tutunma Ã¶zelliÄŸi azaldÄ±ÄŸÄ±ndan, sÃ¼rÃ¼cÃ¼lerin hÄ±zlarÄ±nÄ± limitlerin altÄ±na dÃ¼ÅŸÃ¼rmeleri ve ani manevralardan kaÃ§Ä±nmalarÄ± ÅŸarttÄ±r.");
                }
                if(environment.lighting && environment.lighting.includes('Gece')) {
                    recommendations.push("Gece sÃ¼rÃ¼ÅŸlerinde gÃ¶rÃ¼ÅŸ mesafesi dÃ¼ÅŸtÃ¼ÄŸÃ¼nden, sÃ¼rÃ¼cÃ¼lerin hÄ±zlarÄ±nÄ± farlarÄ±nÄ±n aydÄ±nlattÄ±ÄŸÄ± mesafe iÃ§inde durabilecekleri seviyeye ayarlamalarÄ± gerekmektedir.");
                }

                // KUSUR RAPORU
                if (faultAssessment.length > 0) {
                    report.push("------------------------------------------------");
                    report.push(`âš–ï¸ **KUSUR DURUMU DEÄžERLENDÄ°RMESÄ°**`);
                    faultAssessment.forEach(fault => report.push(fault));
                } else if (vehicles.length > 0) {
                    report.push("------------------------------------------------");
                    report.push(`âš–ï¸ **KUSUR DURUMU DEÄžERLENDÄ°RMESÄ°**`);
                    report.push(`â„¹ï¸ Mevcut kroki verileriyle belirgin bir kural ihlali tespit edilememiÅŸtir. HÄ±z ve dikkatsizlik faktÃ¶rleri incelenmelidir.`);
                }

                // Ã–NERÄ°LER
                if (recommendations.length > 0) {
                    report.push("------------------------------------------------");
                    report.push(`ðŸš— **SÃœRÃœCÃœLER Ä°Ã‡Ä°N GÃœVENLÄ° SÃœRÃœÅž TAVSÄ°YELERÄ°**`);
                    recommendations.forEach(rec => report.push(`â€¢ ${rec}`));
                } else {
                    report.push("------------------------------------------------");
                    report.push(`ðŸš— **SÃœRÃœCÃœLER Ä°Ã‡Ä°N GÃœVENLÄ° SÃœRÃœÅž TAVSÄ°YELERÄ°**`);
                    report.push(`â€¢ SÃ¼rÃ¼cÃ¼lerin direksiyon baÅŸÄ±ndayken dikkat daÄŸÄ±tÄ±cÄ± unsurlardan (telefon vb.) uzak durmalarÄ±.`);
                    report.push(`â€¢ HÄ±z limitlerine uyulmasÄ± ve emniyet kemerinin mutlaka takÄ±lmasÄ±.`);
                }

                // HABER ANALÄ°ZÄ°
                report.push("------------------------------------------------");
                report.push(`ðŸ—žï¸ **Ä°NTERNET KAZA HABERLERÄ° TARAMASI (SÄ°MÃœLASYON)**`);
                if (newsData) {
                    report.push(`**BÃ¶lge:** ${addressInfo.split(',')[0]}`);
                    report.push(`**Bulunan Tahmini Haber SayÄ±sÄ±:** ${newsData.total}`);
                    report.push(`   - AraÃ§ KazasÄ±: ${newsData.car}`);
                    report.push(`   - Motosiklet KazasÄ±: ${newsData.moto}`);
                    report.push(`*(Bu veriler yol Ã¶zelliklerine dayalÄ± tahmini simÃ¼lasyondur. GerÃ§ek veriler iÃ§in aÅŸaÄŸÄ±daki linki kullanÄ±n)*`);
                } else {
                    report.push("Veri oluÅŸturulamadÄ±.");
                }
                
                const query = encodeURIComponent(`${addressInfo.split(',')[0]} kaza haberleri`);
                report.push("");
                report.push(`ðŸ”— **[Google'da GerÃ§ek Kaza Haberlerini Ara](https://www.google.com/search?q=${query})**`);


                report.push("------------------------------------------------");
                report.push("â„¹ï¸ *Bu rapor, krokideki araÃ§ konumlarÄ± ve harita verilerine dayalÄ± yapay zeka tahminidir. Resmi bilirkiÅŸi raporu deÄŸildir.*");

                setAnalysisReport(report.join("\n"));
                setIsAnalyzing(false);
            };

            const getVehicleName = (type) => {
                const types = { 'car': 'Otomobil', 'bus': 'OtobÃ¼s', 'truck': 'Kamyon', 'moto': 'Motosiklet', 'bicycle': 'Bisiklet' };
                return types[type] || 'AraÃ§';
            };

            const downloadAsHtml = () => {
                const currentState = {
                    coords,
                    elements,
                    environment,
                    streetViewMode,
                    apiKey,
                    isViewOnly: true 
                };

                const docClone = document.documentElement.cloneNode(true);
                const rootDiv = docClone.querySelector('#root');
                if (rootDiv) rootDiv.innerHTML = ''; 
                const oldScript = docClone.querySelector('#accident-data');
                if (oldScript) oldScript.remove();

                const dataScript = document.createElement('script');
                dataScript.id = 'accident-data';
                dataScript.text = `window.__ACCIDENT_DATA__ = ${JSON.stringify(currentState)};`;
                
                docClone.querySelector('body').appendChild(dataScript);

                const htmlContent = `<!DOCTYPE html>\n${docClone.outerHTML}`;
                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Kaza_Raporu_${new Date().toISOString().slice(0,10)}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const stateRef = useRef({ elements, selectedId, screenshotMode, courierImage, activeRouteId, mode });
            useEffect(() => { stateRef.current = { elements, selectedId, screenshotMode, courierImage, activeRouteId, mode }; }, [elements, selectedId, screenshotMode, courierImage, activeRouteId, mode]);

            useEffect(() => {
                const handleResize = () => {
                    setCanvasSize({ width: window.innerWidth, height: window.innerHeight });
                    if (mapInstanceRef.current) mapInstanceRef.current.invalidateSize();
                };
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            useEffect(() => {
                const img = new Image();
                img.src = 'Screenshot_2025-01-04_at_22.24.03-removebg-preview.png';
                img.onload = () => setCourierImage(img);
            }, []);

            useEffect(() => {
                if (mapLoaded && mapContainerRef.current && !mapInstanceRef.current && window.L) {
                    const map = window.L.map(mapContainerRef.current, { zoomControl: false }).setView([coords.lat, coords.lng], 18);
                    window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM', maxZoom: 21 }).addTo(map);
                    mapInstanceRef.current = map;
                    markerRef.current = window.L.marker([coords.lat, coords.lng]).addTo(map);
                    map.on('move', () => {}); map.on('zoom', () => {});
                    // BoyutlarÄ± senkronize et
                    setTimeout(() => map.invalidateSize(), 200);
                } else if (mapInstanceRef.current) {
                    mapInstanceRef.current.setView([coords.lat, coords.lng]);
                    if (markerRef.current) markerRef.current.setLatLng([coords.lat, coords.lng]);
                    else if (window.L) markerRef.current = window.L.marker([coords.lat, coords.lng]).addTo(mapInstanceRef.current);
                }
            }, [mapLoaded, coords]);

            useEffect(() => {
                if (mapInstanceRef.current) {
                    if (isViewOnly) {
                        mapInstanceRef.current.dragging.enable();
                    } else {
                        if (isMapLocked) {
                            if(mode === 'pan') { 
                                mapInstanceRef.current.dragging.enable(); 
                            } else { 
                                mapInstanceRef.current.dragging.disable(); 
                            }
                        } else {
                            mapInstanceRef.current.dragging.enable();
                        }
                    }
                }
            }, [isMapLocked, mode, isViewOnly]);

            useEffect(() => { if (mapInstanceRef.current) setTimeout(() => mapInstanceRef.current.invalidateSize(), 100); }, [screenshotMode]);

            const changeMode = (newMode) => {
                if (isViewOnly) return; 
                setMode(newMode);
                if (newMode === 'pan') {
                    setIsMapLocked(false);
                } else {
                    setIsMapLocked(true);
                }
                
                if (newMode !== 'route' && activeRouteId) setActiveRouteId(null);
            };

            const updateSelected = (prop, val) => { if(selectedId) setElements(prev => prev.map(el => el.id === selectedId ? { ...el, [prop]: val } : el)); };
            const deleteSelected = () => { setElements(prev => prev.filter(el => el.id !== selectedId)); setSelectedId(null); };

            const addElement = (type, subType = null, label = null) => {
                if (isViewOnly) return; 
                if (!isMapLocked) setIsMapLocked(true);
                
                const center = mapInstanceRef.current.getCenter();
                const id = Date.now().toString();
                let newElement = { 
                    id, type, subType, 
                    lat: center.lat, lng: center.lng, 
                    rotation: 0, scale: 1, zIndex: 10, 
                    color: '#3b82f6', text: type === 'text' ? 'Not...' : (label || ''), speed: 0, crashed: false 
                };
                
                if (type === 'car') { newElement.width = 40; newElement.height = 80; newElement.color = subType === 'red' ? '#ef4444' : '#3b82f6'; }
                else if (type === 'bus') { newElement.width = 55; newElement.height = 160; newElement.color = '#fbbf24'; }
                else if (type === 'truck') { newElement.width = 55; newElement.height = 140; newElement.color = '#f59e0b'; }
                else if (type === 'moto') { newElement.width = 30; newElement.height = 60; newElement.color = subType === 'courier' ? '#7e22ce' : '#10b981'; }
                else if (type === 'bicycle') { newElement.width = 15; newElement.height = 45; newElement.color = '#ef4444'; }
                else if (type === 'pedestrian') { newElement.width = 20; newElement.height = 20; newElement.color = '#1e293b'; }
                else if (type === 'animal') { newElement.width = 25; newElement.height = 25; newElement.color = '#78350f'; }
                else if (type === 'sign' || type === 'traffic_sign') { newElement.width = 35; newElement.height = 35; } 
                else if (type === 'signal') { newElement.width = 20; newElement.height = 50; }
                else if (type === 'refuge') { newElement.width = 30; newElement.height = 100; }
                else if (type === 'arrow') { newElement.width = 40; newElement.height = 80; newElement.color = '#ffffff'; }
                else if (type === 'road_defect') { newElement.width = 40; newElement.height = 40; }
                // --- DÃœZELTME: YAZI Ä°Ã‡Ä°N SEÃ‡Ä°LEBÄ°LÄ°R ALAN TANIMLANDI ---
                else if (type === 'text') { newElement.width = 100; newElement.height = 40; }
                
                setElements(prev => [...prev, newElement]); setSelectedId(id); setMode('select');
            };

            // --- Ã‡Ä°ZÄ°M FONKSÄ°YONLARI ---
            const drawLabel = (ctx, el) => {
                if (el.text && el.text !== 'Not...') {
                    ctx.save();
                    ctx.rotate(-(el.rotation * Math.PI) / 180);
                    ctx.fillStyle = 'black'; ctx.font = 'bold 11px Arial'; ctx.textAlign = 'center'; ctx.fillText(el.text, 0, el.height/2 * el.scale + 14);
                    ctx.restore();
                }
            };

            const drawTriangleSign = (ctx, el, fillColor, borderColor, symbolFn) => {
                const h = el.height; const w = el.width; ctx.beginPath(); ctx.moveTo(0, -h/2); ctx.lineTo(w/2, h/2); ctx.lineTo(-w/2, h/2); ctx.closePath(); ctx.fillStyle = fillColor; ctx.fill(); ctx.lineWidth = 4; ctx.strokeStyle = borderColor; ctx.stroke(); if (symbolFn) symbolFn(ctx, w, h);
                drawLabel(ctx, el);
            };
            const drawInvertedTriangle = (ctx, el) => {
                const h = el.height; const w = el.width; ctx.beginPath(); ctx.moveTo(-w/2, -h/2); ctx.lineTo(w/2, -h/2); ctx.lineTo(0, h/2); ctx.closePath(); ctx.fillStyle = 'white'; ctx.fill(); ctx.lineWidth = 4; ctx.strokeStyle = '#ef4444'; ctx.stroke();
                drawLabel(ctx, el);
            };
            const drawCircleSign = (ctx, el, fillColor, borderColor, textOrSymbol) => {
                const r = el.width/2; ctx.beginPath(); ctx.arc(0, 0, r, 0, Math.PI*2); ctx.fillStyle = fillColor; ctx.fill(); if (borderColor) { ctx.lineWidth = 4; ctx.strokeStyle = borderColor; ctx.stroke(); } if (typeof textOrSymbol === 'string') { ctx.fillStyle = (fillColor === '#ef4444' || fillColor === '#3b82f6') ? 'white' : 'black'; ctx.font = 'bold 14px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(textOrSymbol, 0, 0); } 
                drawLabel(ctx, el);
            };
            const drawSquareSign = (ctx, el, fillColor, symbolFn) => {
                ctx.fillStyle = fillColor; ctx.fillRect(-el.width/2, -el.height/2, el.width, el.height); ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.strokeRect(-el.width/2+2, -el.height/2+2, el.width-4, el.height-4); if (symbolFn) symbolFn(ctx, el.width, el.height);
                drawLabel(ctx, el);
            };
            const drawDiamondSign = (ctx, el) => {
                ctx.beginPath(); ctx.moveTo(0, -el.height/2); ctx.lineTo(el.width/2, 0); ctx.lineTo(0, el.height/2); ctx.lineTo(-el.width/2, 0); ctx.closePath(); ctx.fillStyle = '#facc15'; ctx.fill(); ctx.lineWidth = 3; ctx.strokeStyle = 'white'; ctx.stroke(); ctx.lineWidth = 1; ctx.strokeStyle = 'black'; ctx.stroke(); 
                drawLabel(ctx, el);
            };
            const drawArrowHead = (ctx, from, to) => {
                const headlen = 15; 
                const dx = to.x - from.x; 
                const dy = to.y - from.y; 
                const angle = Math.atan2(dy, dx); 
                ctx.moveTo(to.x, to.y); 
                ctx.lineTo(to.x - headlen * Math.cos(angle - Math.PI / 6), to.y - headlen * Math.sin(angle - Math.PI / 6)); 
                ctx.moveTo(to.x, to.y); 
                ctx.lineTo(to.x - headlen * Math.cos(angle + Math.PI / 6), to.y - headlen * Math.sin(angle + Math.PI / 6));
            };

            const drawExplosion = (ctx, w, h) => {
                 ctx.fillStyle = '#ef4444'; ctx.beginPath();
                 const spikes=12; const or=w/2; const ir=w/4;
                 for(let i=0; i<spikes*2; i++){ const r=(i%2===0)?or:ir; const a=(Math.PI*i)/spikes; ctx.lineTo(Math.cos(a)*r, Math.sin(a)*r); }
                 ctx.closePath(); ctx.fill(); 
                 ctx.fillStyle = '#facc15'; ctx.beginPath(); 
                 const innerOr = w/3; const innerIr = w/6;
                 for(let i=0; i<spikes*2; i++){ const r=(i%2===0)?innerOr:innerIr; const a=(Math.PI*i)/spikes; ctx.lineTo(Math.cos(a)*r, Math.sin(a)*r); }
                 ctx.closePath(); ctx.fill();
                 ctx.fillStyle='black'; ctx.font='bold 10px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('KAZA', 0, 0);
            };

            const drawCanvas = () => {
                const canvas = canvasRef.current; 
                const map = mapInstanceRef.current;
                if (!canvas || !map) return;
                
                const ctx = canvas.getContext('2d');
                const { elements, selectedId, screenshotMode, courierImage, activeRouteId, mode } = stateRef.current;
                const mPos = mousePosRef.current;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                elements.forEach(el => {
                    let screenX, screenY;
                    let screenPoints = [];

                    if (el.type === 'route') {
                        screenPoints = el.points.map(p => {
                            const pt = map.latLngToContainerPoint([p.lat, p.lng]);
                            return { x: pt.x, y: pt.y };
                        });
                    } else {
                        const pt = map.latLngToContainerPoint([el.lat, el.lng]);
                        screenX = pt.x;
                        screenY = pt.y;
                    }

                    ctx.save();

                    if (el.id === selectedId && !screenshotMode) {
                        ctx.shadowColor = '#facc15'; ctx.shadowBlur = 20;
                    }

                    if (el.type === 'route') {
                        ctx.lineWidth = el.lineWidth || 5;
                        ctx.lineCap = 'round';
                        ctx.lineJoin = 'round';
                        if(el.id !== selectedId) { ctx.shadowColor = el.color; ctx.shadowBlur = 10; }
                        ctx.strokeStyle = el.color;
                        
                        ctx.setLineDash([15, 15]); 
                        const offset = (Date.now() / 20) % 30; 
                        ctx.lineDashOffset = -offset;

                        ctx.beginPath();
                        if (screenPoints.length > 0) {
                            ctx.moveTo(screenPoints[0].x, screenPoints[0].y);
                            for (let i = 1; i < screenPoints.length; i++) { ctx.lineTo(screenPoints[i].x, screenPoints[i].y); }
                            
                            if (el.id === activeRouteId && mode === 'route' && mPos) {
                                ctx.lineTo(mPos.x, mPos.y);
                            }

                            let last, prev;
                            if (el.id === activeRouteId && mPos && screenPoints.length > 0) {
                                last = mPos;
                                prev = screenPoints[screenPoints.length - 1];
                            } else if (screenPoints.length > 1) {
                                last = screenPoints[screenPoints.length - 1];
                                
                                // OK YÃ–NÃœ DÃœZELTME (Geriye dÃ¶nÃ¼k kontrol)
                                // Sondan bir Ã¶nceki noktayÄ± bul (en az 5px uzakta olan)
                                let pIndex = screenPoints.length - 2;
                                while (pIndex >= 0) {
                                    const dist = Math.hypot(last.x - screenPoints[pIndex].x, last.y - screenPoints[pIndex].y);
                                    if (dist > 5) { // 5 pikselden uzak ilk nokta
                                        prev = screenPoints[pIndex];
                                        break;
                                    }
                                    pIndex--;
                                }
                                // EÄŸer hiÃ§biri 5px'den uzak deÄŸilse, en azÄ±ndan 0. indexi al (varsa)
                                if (!prev && screenPoints.length > 1) {
                                    prev = screenPoints[screenPoints.length - 2];
                                }
                            }

                            if (last && prev) {
                                ctx.stroke(); 
                                ctx.beginPath(); 
                                ctx.setLineDash([]); 
                                drawArrowHead(ctx, prev, last);
                            }
                        }
                        ctx.stroke();
                        ctx.shadowBlur = 0; ctx.setLineDash([]);

                    } else {
                        ctx.translate(screenX, screenY); ctx.rotate((el.rotation * Math.PI) / 180); ctx.scale(el.scale, el.scale);
                        
                        if (['car', 'truck', 'bus', 'moto', 'bicycle'].includes(el.type)) {
                            ctx.shadowColor = 'rgba(0,0,0,0.4)'; ctx.shadowBlur = 8; ctx.shadowOffsetY = 4;
                            if (el.type === 'moto' && el.subType === 'courier') {
                                let drawn = false;
                                if (courierImage) { try { ctx.drawImage(courierImage, -el.width/2, -el.height/2, el.width, el.height); drawn = true; } catch (e) {} }
                                if (!drawn) {
                                    const purple = '#5D3EBC'; const yellow = '#FFD300'; const w = el.width; const h = el.height;
                                    ctx.shadowColor = 'rgba(0,0,0,0.5)'; ctx.shadowBlur = 5;
                                    ctx.fillStyle = purple; roundRect(ctx, -w/2, -h/2, w, h, 4); ctx.fill();
                                    ctx.fillStyle = yellow; ctx.fillRect(-w/2 + 2, h/2 - 18, w - 4, 16);
                                    ctx.fillStyle = 'rgba(255,255,255,0.9)'; ctx.beginPath(); ctx.arc(0, -h/2 + 10, 6, 0, Math.PI*2); ctx.fill();
                                    ctx.fillStyle = purple; ctx.beginPath(); ctx.ellipse(0, -h/2 + 18, 10, 4, 0, 0, Math.PI*2); ctx.fill();
                                    ctx.shadowBlur = 0;
                                }
                            } else if (el.type === 'car') draw3DCar(ctx, el.width, el.height, el.color);
                            else if (el.type === 'bus') draw3DBus(ctx, el.width, el.height, el.color);
                            else if (el.type === 'truck') draw3DTruck(ctx, el.width, el.height, el.color);
                            else {
                                ctx.fillStyle = el.color;
                                if(el.type==='bicycle') { roundRect(ctx, -el.width/2, -el.height/2, el.width, el.height, 5); ctx.fill(); ctx.fillStyle = '#cbd5e1'; ctx.fillRect(-10, -el.height/2 + 5, 20, 2); }
                                else { roundRect(ctx, -el.width/2, -el.height/2, el.width, el.height, 4); ctx.fill(); }
                            }
                            ctx.shadowBlur = 0;
                        }
                        else if (el.type === 'road_defect') {
                            if(el.subType==='pothole') { ctx.fillStyle='#374151'; ctx.beginPath(); ctx.ellipse(0,0,el.width/2,el.height/2,0,0,Math.PI*2); ctx.fill(); drawLabel(ctx, el);}
                            else if(el.subType==='slippery') { ctx.strokeStyle='#000'; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(-10,-10); ctx.bezierCurveTo(0,-10,-10,0,0,0); ctx.stroke(); ctx.beginPath(); ctx.moveTo(-10,5); ctx.bezierCurveTo(0,5,-10,15,0,15); ctx.stroke(); drawLabel(ctx, el);}
                        }
                        else if (el.type === 'sign' && el.subType === 'crash_point') {
                            drawExplosion(ctx, el.width, el.height);
                        }
                        else if (el.type === 'traffic_sign') {
                             if (el.subType === 'danger_general') drawTriangleSign(ctx, el, 'white', '#ef4444', (c)=>{c.fillStyle='black';c.font='bold 20px Arial';c.textAlign='center';c.fillText('!',0,5)});
                             else if (el.subType === 'limit_speed') drawCircleSign(ctx, el, 'white', '#ef4444', el.text);
                             else if (el.subType === 'no_entry') drawCircleSign(ctx, el, '#ef4444', null, (c,r)=>{c.fillStyle='white';c.fillRect(-r+5,-3,r*2-10,6)});
                             else if (el.subType === 'priority_stop') {ctx.fillStyle='#ef4444';ctx.beginPath();for(let i=0;i<8;i++){const a=(Math.PI/4)*i+Math.PI/8;ctx.lineTo(Math.cos(a)*el.width/2,Math.sin(a)*el.height/2)}ctx.closePath();ctx.fill();ctx.fillStyle='white';ctx.font='bold 10px Arial';ctx.textAlign='center';ctx.fillText('DUR',0,0); drawLabel(ctx, el);}
                             else if (el.subType === 'info_parking') drawSquareSign(ctx, el, '#3b82f6', (c)=>{c.fillStyle='white';c.font='bold 20px Arial';c.textAlign='center';c.fillText('P',0,5)});
                             else if (el.subType === 'priority_yield') drawInvertedTriangle(ctx, el);
                             else if (el.subType === 'priority_main') drawDiamondSign(ctx, el);
                             else if (el.subType === 'danger_pedestrian') drawTriangleSign(ctx, el, 'white', '#ef4444', (c)=>{c.fillStyle='black';c.font='bold 20px Arial';c.textAlign='center';c.fillText('ðŸš¶',0,5)});
                             else if (el.subType === 'danger_intersection') drawTriangleSign(ctx, el, 'white', '#ef4444', (c)=>{c.fillStyle='black';c.font='bold 20px Arial';c.textAlign='center';c.fillText('âœ–',0,5)});
                             else if (el.subType === 'danger_train') drawTriangleSign(ctx, el, 'white', '#ef4444', (c)=>{c.fillStyle='black';c.font='bold 20px Arial';c.textAlign='center';c.fillText('ðŸš‚',0,5)});
                             else if (el.subType === 'danger_gravel') drawTriangleSign(ctx, el, 'white', '#ef4444', (c)=>{c.fillStyle='black';c.font='bold 20px Arial';c.textAlign='center';c.fillText('.:',0,5)});
                        }
                        else if (el.type === 'signal') {
                             ctx.fillStyle='#1f2937'; ctx.fillRect(-10,-25,20,50); ctx.fillStyle='#4b5563'; 
                             ctx.beginPath(); ctx.arc(0,-15,6,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(0,0,6,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(0,15,6,0,Math.PI*2); ctx.fill();
                             if(el.subType==='red'){ctx.fillStyle='#ef4444';ctx.beginPath();ctx.arc(0,-15,6,0,Math.PI*2);ctx.fill()}
                             else if(el.subType==='yellow'){ctx.fillStyle='#eab308';ctx.beginPath();ctx.arc(0,0,6,0,Math.PI*2);ctx.fill()}
                             else if(el.subType==='green'){ctx.fillStyle='#22c55e';ctx.beginPath();ctx.arc(0,15,6,0,Math.PI*2);ctx.fill()}
                        }
                        else if (el.type === 'refuge') {
                             ctx.shadowColor='rgba(0,0,0,0.3)'; ctx.shadowBlur=5;
                             ctx.fillStyle = '#cbd5e1'; // Beton rengi
                             roundRect(ctx, -el.width/2, -el.height/2, el.width, el.height, 8);
                             ctx.fill();
                             ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 2; ctx.stroke(); // KenarlÄ±k
                             
                             // TaralÄ± Ã§izgiler
                             ctx.beginPath();
                             ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 2;
                             for(let i = -el.height/2 + 10; i < el.height/2; i+=15) {
                                 ctx.moveTo(-el.width/2 + 5, i);
                                 ctx.lineTo(el.width/2 - 5, i + 8);
                             }
                             ctx.stroke();
                             ctx.shadowBlur=0;
                        }
                        else if(el.type==='arrow') { ctx.fillStyle=el.color||'#ffffff'; ctx.shadowColor='rgba(0,0,0,0.5)'; ctx.shadowBlur=2; if(el.subType==='straight'){ctx.beginPath();ctx.moveTo(-5,20);ctx.lineTo(-5,-10);ctx.lineTo(-15,-10);ctx.lineTo(0,-30);ctx.lineTo(15,-10);ctx.lineTo(5,-10);ctx.lineTo(5,20);ctx.fill()} else if(el.subType==='turn_left'){ctx.beginPath();ctx.moveTo(10,20);ctx.lineTo(0,20);ctx.quadraticCurveTo(-10,20,-10,10);ctx.lineTo(-10,0);ctx.lineTo(-20,0);ctx.lineTo(0,-20);ctx.lineTo(20,0);ctx.lineTo(10,0);ctx.lineTo(10,10);ctx.fill()} else if(el.subType==='turn_right'){ctx.scale(-1,1);ctx.beginPath();ctx.moveTo(10,20);ctx.lineTo(0,20);ctx.quadraticCurveTo(-10,20,-10,10);ctx.lineTo(-10,0);ctx.lineTo(-20,0);ctx.lineTo(0,-20);ctx.lineTo(20,0);ctx.lineTo(10,0);ctx.lineTo(10,10);ctx.fill();ctx.scale(-1,1)} ctx.shadowBlur=0; }
                        else if(el.type==='text') { ctx.font='bold 16px Arial'; ctx.fillStyle=el.color||'#000'; ctx.strokeStyle='white'; ctx.lineWidth=3; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.strokeText(el.text,0,0); ctx.fillText(el.text,0,0); }
                        else if(el.type==='pedestrian') { ctx.shadowColor='rgba(0,0,0,0.5)'; ctx.shadowBlur=3; ctx.fillStyle=el.color; ctx.beginPath(); ctx.arc(0,0,8,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#64748b'; ctx.beginPath(); ctx.ellipse(0,0,12,6,0,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0; } 
                        else if(el.type==='animal') { ctx.fillStyle=el.color; ctx.beginPath(); ctx.arc(0,2,6,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(-6,-5,2.5,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(0,-8,2.5,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(6,-5,2.5,0,Math.PI*2); ctx.fill(); }

                        if (selectedId === el.id && !screenshotMode && el.type !== 'route') {
                            ctx.strokeStyle='#2563eb'; ctx.lineWidth=2; ctx.setLineDash([4,4]);
                            const bw = (el.type==='arrow'?40:el.width)*el.scale; const bh = (el.type==='arrow'?60:el.height)*el.scale;
                            ctx.strokeRect(-bw/2-5, -bh/2-5, bw+10, bh+10);
                            ctx.beginPath(); ctx.moveTo(0, -bh/2-5); ctx.lineTo(0, -bh/2-25); ctx.stroke();
                            ctx.beginPath(); ctx.arc(0, -bh/2-25, 4, 0, Math.PI*2); ctx.fillStyle='#fff'; ctx.fill(); ctx.stroke();
                            ctx.setLineDash([]);
                        }
                    }
                    ctx.restore();
                });
            };

            // Animasyon DÃ¶ngÃ¼sÃ¼
            useEffect(() => {
                let animationFrameId;
                const render = () => {
                    drawCanvas();
                    animationFrameId = requestAnimationFrame(render);
                };
                render();
                return () => cancelAnimationFrame(animationFrameId);
            }, []); 

            const handlePointerDown = (e) => {
                if (isViewOnly) return; 
                if (!isMapLocked) return;
                const rect = canvasRef.current.getBoundingClientRect();
                const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left; const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;
                
                const latlng = mapInstanceRef.current.containerPointToLatLng([x, y]);

                if (mode === 'route') { 
                    if (activeRouteId) {
                        setElements(prev => prev.map(el => {
                            if (el.id === activeRouteId) {
                                return { ...el, points: [...el.points, {lat: latlng.lat, lng: latlng.lng}] };
                            }
                            return el;
                        }));
                    } else {
                        const newEl = { 
                            id: Date.now().toString(), 
                            type: 'route', 
                            points: [{lat: latlng.lat, lng: latlng.lng}], 
                            color: drawingColor, 
                            lineWidth: drawingWidth, 
                            zIndex: 100 
                        }; 
                        setElements(prev => [...prev, newEl]); 
                        setActiveRouteId(newEl.id);
                        setSelectedId(newEl.id); 
                    }
                    return; 
                }
                
                if (mode === 'eraser') {
                     const clickedIds = [];
                     const rev = [...elements].reverse();
                     for (let el of rev) {
                         if (el.type === 'route') {
                             for (let p of el.points) {
                                 const pt = mapInstanceRef.current.latLngToContainerPoint([p.lat, p.lng]);
                                 if (Math.hypot(pt.x - x, pt.y - y) < 20) { clickedIds.push(el.id); break; } 
                             }
                         } else {
                             const pt = mapInstanceRef.current.latLngToContainerPoint([el.lat, el.lng]);
                             const hw = (el.width*el.scale)/2; const hh = (el.height*el.scale)/2; 
                             if (Math.abs(pt.x - x) < hw+15 && Math.abs(pt.y - y) < hh+15) { clickedIds.push(el.id); break; } 
                         }
                     }
                     if(clickedIds.length > 0) {
                         setElements(prev => prev.filter(el => el.id !== clickedIds[0]));
                         setSelectedId(null);
                         if(clickedIds[0] === activeRouteId) setActiveRouteId(null);
                     }
                     return;
                }

                let clickedId = null; const rev = [...elements].reverse();
                for (let el of rev) { 
                    if (el.type === 'route') {
                        for (let p of el.points) {
                            const pt = mapInstanceRef.current.latLngToContainerPoint([p.lat, p.lng]);
                            if (Math.hypot(pt.x - x, pt.y - y) < 20) { clickedId = el.id; break; }
                        }
                    } else {
                        const pt = mapInstanceRef.current.latLngToContainerPoint([el.lat, el.lng]);
                        const hw = (el.width*el.scale)/2; const hh = (el.height*el.scale)/2; 
                        if (Math.abs(pt.x - x) < hw+15 && Math.abs(pt.y - y) < hh+15) { clickedId = el.id; break; } 
                    }
                    if (clickedId) break;
                }
                if (clickedId) { 
                    setSelectedId(clickedId); 
                    setAction('moving'); 
                    setDragStart(latlng); 
                } else { setSelectedId(null); setAction('none'); }
            };

            const handlePointerMove = (e) => {
                if (isViewOnly) return; 
                if (!isMapLocked) return;
                const rect = canvasRef.current.getBoundingClientRect();
                const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left; const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;
                const latlng = mapInstanceRef.current.containerPointToLatLng([x, y]);
                mousePosRef.current = {x, y};

                if (action === 'moving' && selectedId) { 
                    const dLat = latlng.lat - dragStart.lat;
                    const dLng = latlng.lng - dragStart.lng;
                    setElements(prev => prev.map(el => {
                        if (el.id === selectedId) {
                            if (el.type === 'route') {
                                return { ...el, points: el.points.map(p => ({ lat: p.lat + dLat, lng: p.lng + dLng })) };
                            }
                            return { ...el, lat: el.lat + dLat, lng: el.lng + dLng };
                        }
                        return el;
                    })); 
                    setDragStart(latlng); 
                }
            };
            const handlePointerUp = () => setAction('none');
            
            const finishRoute = () => { setActiveRouteId(null); };

            return (
                <div className="flex flex-col h-screen bg-slate-100 font-sans overflow-hidden">
                    {!screenshotMode && (
                        <div className="bg-white p-2 shadow z-20 flex gap-2 items-center justify-between border-b">
                            <div className="flex items-center gap-2 font-bold text-blue-900">
                                <Icon name="alert-triangle" className="text-red-500"/> 
                                {isViewOnly ? 'Kaza TutanaÄŸÄ± (Salt Okunur)' : 'Kaza TutanaÄŸÄ±'}
                            </div>
                            
                            <div className="flex gap-1 bg-gray-50 p-1 rounded border text-xs items-center">
                                {!isViewOnly && (
                                    <>
                                        <button onClick={handleZoomOut} className="p-1 hover:bg-gray-200 rounded" ><Icon name="minus" size={14}/></button>
                                        <button onClick={handleZoomIn} className="p-1 hover:bg-gray-200 rounded" ><Icon name="plus" size={14}/></button>
                                    </>
                                )}
                                <input type="text" disabled={isViewOnly} className={`w-20 p-1 border rounded ${isViewOnly ? 'bg-gray-100 text-gray-500' : ''}`} value={inputCoords.lat} onChange={e=>setInputCoords({...inputCoords, lat:e.target.value})}/>
                                <input type="text" disabled={isViewOnly} className={`w-20 p-1 border rounded ${isViewOnly ? 'bg-gray-100 text-gray-500' : ''}`} value={inputCoords.lng} onChange={e=>setInputCoords({...inputCoords, lng:e.target.value})}/>
                                {!isViewOnly && (
                                    <button onClick={()=>{setCoords({lat: parseFloat(inputCoords.lat), lng: parseFloat(inputCoords.lng)})}} className="bg-blue-600 text-white p-1 rounded"><Icon name="navigation" size={14}/></button>
                                )}
                            </div>
                            <div className="flex gap-2">
                                <button onClick={generateAccidentReport} className="flex items-center gap-1 bg-purple-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-purple-700 shadow-sm">
                                    <Icon name="brain-circuit" size={14}/> Analiz Et
                                </button>
                                <button onClick={() => setShowHelp(true)} className="flex items-center gap-1 bg-orange-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-orange-600 shadow-sm">
                                    <Icon name="help-circle" size={14}/> NasÄ±l KullanÄ±lÄ±r?
                                </button>
                                {!isViewOnly && (
                                    <button onClick={downloadAsHtml} className="flex items-center gap-1 bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-blue-700" title="Bu projeyi interaktif bir HTML dosyasÄ± olarak indir">
                                        <Icon name="download" size={14}/> HTML Ä°ndir
                                    </button>
                                )}
                                {!isViewOnly && (
                                    <button onClick={()=>setScreenshotMode(true)} className="flex items-center gap-1 bg-green-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-green-700"><Icon name="camera" size={14}/> Foto</button>
                                )}
                            </div>
                        </div>
                    )}

                    {/* YARDIM MODALI */}
                    {showHelp && (
                        <div className="absolute inset-0 z-50 flex items-center justify-center modal-overlay p-4" onClick={() => setShowHelp(false)}>
                            <div className="bg-white rounded-lg shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                                <div className="p-4 bg-orange-500 text-white rounded-t-lg flex justify-between items-center sticky top-0 z-10">
                                    <h2 className="text-lg font-bold flex items-center gap-2"><Icon name="help-circle"/> KullanÄ±m KÄ±lavuzu</h2>
                                    <button onClick={() => setShowHelp(false)}><Icon name="x"/></button>
                                </div>
                                <div className="p-6 space-y-6">
                                    <div className="help-step">
                                        <div className="help-icon"><Icon name="map-pin"/></div>
                                        <div className="help-content">
                                            <h4>1. Konum Belirleme</h4>
                                            <p>Harita Ã¼zerinde sÃ¼rÃ¼kleyerek veya Ã¼st bardaki koordinat kutucuklarÄ±na girerek kaza mahalline gidin. <Icon name="navigation" size={12}/> butonuna basarak konuma odaklanÄ±n.</p>
                                        </div>
                                    </div>
                                    <div className="help-step">
                                        <div className="help-icon"><Icon name="car"/></div>
                                        <div className="help-content">
                                            <h4>2. AraÃ§ ve Nesne Ekleme</h4>
                                            <p>Sol menÃ¼deki sekmelerden nesneye tÄ±klayÄ±n. Nesne haritanÄ±n ortasÄ±na gelecektir.</p>
                                        </div>
                                    </div>
                                    <div className="help-step">
                                        <div className="help-icon"><Icon name="move"/></div>
                                        <div className="help-content">
                                            <h4>3. DÃ¼zenleme</h4>
                                            <p>Nesneyi sÃ¼rÃ¼kleyin. SeÃ§ili nesnenin <strong>YÃ¶nÃ¼nÃ¼</strong> ve <strong>Boyutunu</strong> ayarlayabilirsiniz.</p>
                                        </div>
                                    </div>
                                    <div className="help-step">
                                        <div className="help-icon"><Icon name="brain-circuit"/></div>
                                        <div className="help-content">
                                            <h4>4. Analiz</h4>
                                            <p><strong>"Analiz Et"</strong> butonuna basarak yapay zeka destekli kaza raporunu oluÅŸturun.</p>
                                        </div>
                                    </div>
                                </div>
                                <div className="p-4 border-t text-center">
                                    <button onClick={() => setShowHelp(false)} className="bg-orange-500 text-white px-6 py-2 rounded font-bold">AnladÄ±m</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="flex flex-1 overflow-hidden relative">
                        {!screenshotMode && !isViewOnly && (
                            <div className="w-64 bg-white border-r z-20 flex flex-col overflow-y-auto shadow-lg">
                                
                                <div className="flex-1">
                                    
                                    <div className="p-2 border-b space-y-2">
                                        <div className="flex gap-2">
                                            <button onClick={()=>changeMode('select')} className={`flex-1 p-1 border rounded ${mode==='select'?'bg-blue-100':''}`} title="SeÃ§"><Icon name="mouse-pointer-2" size={16} className="mx-auto"/></button>
                                            <button onClick={()=>changeMode('route')} className={`flex-1 p-1 border rounded ${mode==='route'?'bg-blue-100':''}`} title="Rota Ã‡iz (Yol)"><Icon name="route" size={16} className="mx-auto"/></button>
                                            <button onClick={()=>changeMode('eraser')} className={`flex-1 p-1 border rounded ${mode==='eraser'?'bg-blue-100':''}`} title="Silgi"><Icon name="eraser" size={16} className="mx-auto"/></button>
                                            <button onClick={()=>changeMode('pan')} className={`flex-1 p-1 border rounded ${mode==='pan'?'bg-blue-100':''}`} title="HaritayÄ± KaydÄ±r"><Icon name="hand" size={16} className="mx-auto"/></button>
                                        </div>
                                        
                                        {(mode==='route') && (
                                            <div className="flex flex-col gap-2">
                                                {activeRouteId && (
                                                    <button onClick={finishRoute} className="w-full py-1 bg-green-100 text-green-700 text-xs font-bold rounded border border-green-200 hover:bg-green-200">
                                                        âœ“ RotayÄ± Bitir
                                                    </button>
                                                )}
                                                <div className="flex gap-2 items-center">
                                                    <input type="color" value={drawingColor} onChange={e=>setDrawingColor(e.target.value)} className="w-8 h-6 rounded cursor-pointer border"/>
                                                    <div className="flex-1 flex items-center gap-1">
                                                        <span className="text-[8px] text-gray-500">KalÄ±nlÄ±k:</span>
                                                        <input type="range" min="1" max="20" value={drawingWidth} onChange={e=>setDrawingWidth(parseInt(e.target.value))} className="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer"/>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    <MenuItem id="vehicles" title="AraÃ§lar" icon="car">
                                        <ButtonEl onClick={()=>addElement('moto','courier')} icon="bike" label="Kurye" color="text-purple-700" bg="bg-purple-50"/>
                                        <ButtonEl onClick={()=>addElement('car','blue')} icon="car" label="Oto A" color="text-blue-600"/>
                                        <ButtonEl onClick={()=>addElement('car','red')} icon="car" label="Oto B" color="text-red-600"/>
                                        <ButtonEl onClick={()=>addElement('bus')} icon="bus" label="OtobÃ¼s" color="text-yellow-600"/>
                                        <ButtonEl onClick={()=>addElement('truck')} icon="truck" label="Kamyon" color="text-orange-600"/>
                                        <ButtonEl onClick={()=>addElement('moto')} icon="bike" label="Moto" color="text-green-600"/>
                                        <ButtonEl onClick={()=>addElement('bicycle')} icon="bike" label="Bisiklet" color="text-red-500"/>
                                        <ButtonEl onClick={()=>addElement('pedestrian')} icon="user" label="Yaya"/>
                                    </MenuItem>

                                    <MenuItem id="env" title="Ã‡evre Durumu" icon="sun">
                                        <div className="col-span-4 text-[10px] font-bold text-orange-500">AYDINLATMA</div>
                                        <button onClick={()=>setEnvironment({...environment, lighting: 'GÃ¼ndÃ¼z'})} className="col-span-2 p-1 border rounded text-[9px] flex gap-1"><Icon name="sun" size={12} className="text-orange-500"/> GÃ¼ndÃ¼z</button>
                                        <button onClick={()=>setEnvironment({...environment, lighting: 'Gece (Ä°yi)'})} className="col-span-2 p-1 border rounded text-[9px] flex gap-1"><Icon name="moon" size={12} className="text-blue-800"/> Gece (Ä°yi)</button>
                                        <button onClick={()=>setEnvironment({...environment, lighting: 'Gece (KÃ¶tÃ¼)'})} className="col-span-2 p-1 border rounded text-[9px] flex gap-1"><Icon name="moon" size={12} className="text-black"/> Gece (KÃ¶tÃ¼)</button>
                                        <button onClick={()=>setEnvironment({...environment, lighting: 'AlacakaranlÄ±k'})} className="col-span-2 p-1 border rounded text-[9px] flex gap-1"><Icon name="cloud-sun" size={12} className="text-purple-500"/> AlacakaranlÄ±k</button>

                                        <div className="col-span-4 text-[10px] font-bold text-blue-500 mt-2">HAVA DURUMU</div>
                                        <ButtonEl onClick={()=>setEnvironment({...environment, weather: 'GÃ¼neÅŸli'})} icon="sun" label="GÃ¼neÅŸli" color="text-orange-500"/>
                                        <ButtonEl onClick={()=>setEnvironment({...environment, weather: 'YaÄŸmurlu'})} icon="cloud-rain" label="YaÄŸmur" color="text-blue-600"/>
                                        <ButtonEl onClick={()=>setEnvironment({...environment, weather: 'KarlÄ±'})} icon="cloud-snow" label="Kar" color="text-sky-400"/>
                                        <ButtonEl onClick={()=>setEnvironment({...environment, weather: 'Sisli'})} icon="cloud-fog" label="Sis" color="text-gray-400"/>
                                        
                                        <div className="col-span-4 border-t mt-2 pt-1"></div>
                                        <ButtonEl onClick={()=>addElement('sign','crash_point')} icon="zap" label="Ã‡arpÄ±ÅŸma NoktasÄ±" color="text-red-600" bg="bg-red-50"/>
                                    </MenuItem>

                                    <MenuItem id="road" title="Yol & Trafik" icon="arrow-up">
                                        <ButtonEl onClick={()=>addElement('traffic_sign','danger_pedestrian', 'Yaya GeÃ§idi')} icon="triangle" label="Yaya GeÃ§idi" color="text-red-500"/>
                                        <ButtonEl onClick={()=>addElement('traffic_sign','danger_intersection', 'KavÅŸak')} icon="triangle" label="KavÅŸak" color="text-red-500"/>
                                        <ButtonEl onClick={()=>addElement('traffic_sign','danger_train', 'Tren Yolu')} icon="triangle" label="Tren Yolu" color="text-red-500"/>
                                        <ButtonEl onClick={()=>addElement('traffic_sign','danger_gravel', 'MÄ±cÄ±r')} icon="triangle" label="MÄ±cÄ±r" color="text-red-500"/>
                                        <ButtonEl onClick={()=>addElement('traffic_sign','limit_speed','50')} icon="circle" label="50" color="text-red-500"/>
                                        <ButtonEl onClick={()=>addElement('traffic_sign','priority_stop')} icon="octagon" label="DUR" color="text-red-500"/>
                                        <ButtonEl onClick={()=>addElement('signal','red')} icon="traffic-cone" label="KÄ±rmÄ±zÄ± IÅŸÄ±k" color="text-red-500"/>
                                        <ButtonEl onClick={()=>addElement('signal','green')} icon="traffic-cone" label="YeÅŸil IÅŸÄ±k" color="text-green-500"/>
                                        <ButtonEl onClick={()=>addElement('road_defect','pothole')} icon="circle" label="Ã‡ukur"/>
                                        <ButtonEl onClick={()=>addElement('road_defect','slippery')} icon="waves" label="Kaygan"/>
                                        <ButtonEl onClick={()=>addElement('refuge')} icon="minus" label="RefÃ¼j" color="text-slate-500 rotate-90"/>
                                        <ButtonEl onClick={()=>addElement('text')} icon="type" label="YazÄ±" />
                                    </MenuItem>

                                    {selectedId && (
                                        <div className="p-2 m-2 bg-blue-50 rounded border border-blue-100">
                                            <div className="flex justify-between mb-1">
                                                <span className="text-[10px] font-bold text-blue-800">DÃœZENLE</span>
                                                <button onClick={()=>{setElements(prev=>prev.filter(el=>el.id!==selectedId));setSelectedId(null)}} className="text-red-500"><Icon name="trash-2" size={14}/></button>
                                            </div>
                                            
                                            {(elements.find(e=>e.id===selectedId)?.type === 'route') ? (
                                                <div className="space-y-2">
                                                    <div>
                                                        <label className="text-[9px] block text-gray-500 mb-1">Ã‡izgi KalÄ±nlÄ±ÄŸÄ±</label>
                                                        <input 
                                                            type="range" min="1" max="20" 
                                                            className="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer" 
                                                            value={elements.find(e=>e.id===selectedId)?.lineWidth || 5} 
                                                            onChange={e=>updateSelected('lineWidth', parseInt(e.target.value))}
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="text-[9px] block text-gray-500 mb-1">Renk</label>
                                                        <input 
                                                            type="color" 
                                                            className="w-full h-6 rounded border cursor-pointer"
                                                            value={elements.find(e=>e.id===selectedId)?.color || '#ef4444'} 
                                                            onChange={e=>updateSelected('color', e.target.value)}
                                                        />
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="space-y-2">
                                                    <div><label className="text-[9px] block">YÃ¶n</label><input type="range" min="0" max="360" className="w-full" value={elements.find(e=>e.id===selectedId)?.rotation || 0} onChange={e=>{if(selectedId)setElements(prev=>prev.map(el=>el.id===selectedId?{...el,rotation:parseInt(e.target.value)}:el))}}/></div>
                                                    <div><label className="text-[9px] block">Boyut</label><input type="range" min="0.5" max="3" step="0.1" className="w-full" value={elements.find(e=>e.id===selectedId)?.scale || 1} onChange={e=>{if(selectedId)setElements(prev=>prev.map(el=>el.id===selectedId?{...el,scale:parseFloat(e.target.value)}:el))}}/></div>
                                                    {(elements.find(e=>e.id===selectedId)?.type==='text' || (elements.find(e=>e.id===selectedId)?.type==='traffic_sign' && elements.find(e=>e.id===selectedId)?.subType === 'limit_speed')) && (
                                                        <input type="text" className="w-full p-1 text-xs border rounded" value={elements.find(e=>e.id===selectedId)?.text || ''} onChange={e=>updateSelected('text',e.target.value)}/>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        <div className="flex-1 relative bg-gray-200 overflow-hidden">
                            {/* DÃœZELTME: h-full w-full eklendi */}
                            <div ref={mapContainerRef} className="absolute inset-0 z-0 h-full w-full" style={{filter: isMapLocked?'grayscale(30%)':'none'}}></div>
                            
                            {(environment.lighting || environment.weather) && (
                                <div className="absolute top-4 right-4 z-10 bg-white/90 p-2 rounded shadow border border-slate-200 text-xs pointer-events-none">
                                    {environment.lighting && <div><strong>AydÄ±nlatma:</strong> {environment.lighting}</div>}
                                    {environment.weather && <div><strong>Hava:</strong> {environment.weather}</div>}
                                </div>
                            )}
                            
                            {!screenshotMode && (
                                <div className="absolute bottom-4 right-4 z-10 bg-white/90 p-2 rounded shadow border border-slate-200 w-64">
                                    <div className="text-[10px] font-bold text-gray-600 mb-1 flex justify-between items-center">
                                        <span>Sokak GÃ¶rÃ¼nÃ¼mÃ¼</span>
                                        <div className="flex gap-1">
                                            <button 
                                                onClick={() => setStreetViewMode('image')}
                                                className={`px-2 py-0.5 rounded text-[9px] border ${streetViewMode === 'image' ? 'bg-blue-100 border-blue-300 text-blue-700' : 'bg-gray-50 text-gray-500'}`}
                                            >
                                                Resim
                                            </button>
                                            <button 
                                                onClick={() => setStreetViewMode('embed')}
                                                className={`px-2 py-0.5 rounded text-[9px] border flex items-center gap-1 ${streetViewMode === 'embed' ? 'bg-blue-100 border-blue-300 text-blue-700' : 'bg-gray-50 text-gray-500'}`}
                                            >
                                                <Icon name="rotate-3d" size={10}/> 360Â°
                                            </button>
                                        </div>
                                        <a href={`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${coords.lat},${coords.lng}`} target="_blank" rel="noreferrer" className="text-blue-500 hover:underline text-[8px]">
                                            <Icon name="external-link" size={10}/>
                                        </a>
                                    </div>
                                    
                                    <div className="w-full h-40 bg-gray-200 rounded overflow-hidden relative group">
                                        {streetViewMode === 'image' ? (
                                            <>
                                                <img 
                                                    src={`https://cbk0.google.com/cbk?output=thumbnail&w=320&h=240&ll=${coords.lat},${coords.lng}`} 
                                                    alt="Sokak GÃ¶rÃ¼nÃ¼mÃ¼" 
                                                    className="w-full h-full object-cover"
                                                    onError={(e) => {e.target.style.display='none'; e.target.parentElement.querySelector('.fallback').style.display='flex'}}
                                                />
                                                <div className="fallback absolute inset-0 hidden items-center justify-center text-[9px] text-gray-500 text-center bg-gray-100 p-2">
                                                    GÃ¶rÃ¼ntÃ¼ yok veya API eriÅŸilemiyor
                                                </div>
                                            </>
                                        ) : (
                                            apiKey ? (
                                                <iframe
                                                    width="100%"
                                                    height="100%"
                                                    style={{border:0}}
                                                    loading="lazy"
                                                    allowFullScreen
                                                    src={`https://www.google.com/maps/embed/v1/streetview?key=${apiKey}&location=${coords.lat},${coords.lng}`}
                                                ></iframe>
                                            ) : (
                                                <div className="absolute inset-0 bg-gray-100 flex flex-col items-center justify-center p-2 text-center">
                                                    <p className="text-[9px] text-gray-600 mb-2 font-bold">CanlÄ± 360Â° gÃ¶rÃ¼nÃ¼m iÃ§in Google Maps API AnahtarÄ± gereklidir.</p>
                                                    <input 
                                                        type="text" 
                                                        placeholder="API Key Giriniz" 
                                                        className="w-full p-1 border rounded text-[9px] mb-1"
                                                        value={tempKey}
                                                        onChange={(e) => setTempKey(e.target.value)}
                                                    />
                                                    <button onClick={saveApiKey} className="bg-blue-600 text-white px-2 py-1 rounded text-[9px] w-full">Kaydet</button>
                                                    <p className="text-[8px] text-gray-400 mt-1">TarayÄ±cÄ±ya kaydedilir.</p>
                                                </div>
                                            )
                                        )}
                                        {streetViewMode === 'embed' && apiKey && (
                                            <button onClick={clearApiKey} className="absolute top-1 right-1 bg-white/80 p-1 rounded text-[8px] text-red-500 hover:bg-white" title="AnahtarÄ± Sil">
                                                <Icon name="x" size={10}/>
                                            </button>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* ANALÄ°Z MODALI */}
                            {isAnalyzing && (
                                <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
                                    <div className="bg-white p-6 rounded-lg shadow-2xl animate-pulse">
                                        <h2 className="text-xl font-bold mb-2 text-purple-700 flex items-center gap-2">
                                            <Icon name="brain-circuit" className="animate-spin"/> Analiz YapÄ±lÄ±yor...
                                        </h2>
                                        <p className="text-sm text-gray-600">Harita verileri taranÄ±yor...</p>
                                    </div>
                                </div>
                            )}

                            {analysisReport && (
                                <div className="absolute top-14 left-4 right-4 md:left-auto md:right-4 md:w-80 z-40 bg-white rounded-lg shadow-2xl border border-purple-200 flex flex-col max-h-[80vh]">
                                    <div className="p-3 bg-purple-600 text-white rounded-t-lg flex justify-between items-center">
                                        <h3 className="font-bold text-sm flex items-center gap-2"><Icon name="file-text" size={16}/> Yapay Zeka Raporu</h3>
                                        <button onClick={() => setAnalysisReport(null)} className="hover:bg-purple-700 p-1 rounded"><Icon name="x" size={16}/></button>
                                    </div>
                                    <div className="p-4 overflow-y-auto text-sm text-slate-700 space-y-2 leading-relaxed whitespace-pre-line">
                                        {analysisReport}
                                    </div>
                                </div>
                            )}

                            <canvas 
                                ref={canvasRef} width={canvasSize.width} height={canvasSize.height}
                                className={`absolute inset-0 z-10 ${isMapLocked&&mode!=='pan'?'cursor-crosshair pointer-events-auto':'pointer-events-none'} ${!screenshotMode?'border-dashed border-slate-400 shadow-2xl':''}`}
                                style={{pointerEvents: mode === 'pan' ? 'none' : 'auto'}}
                                onMouseDown={handlePointerDown} onMouseMove={handlePointerMove} onMouseUp={handlePointerUp} onMouseLeave={handlePointerUp}
                                onTouchStart={handlePointerDown} onTouchMove={handlePointerMove} onTouchEnd={handlePointerUp}
                            />
                            {screenshotMode && <div className="absolute top-4 left-4 z-30 bg-black/80 text-white p-3 rounded text-center"><h3 className="font-bold">Foto Modu</h3><button onClick={()=>setScreenshotMode(false)} className="bg-white text-black px-2 py-1 rounded text-xs mt-2 font-bold">Kapat</button></div>}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MapAccidentSketch />);
    </script>
</body>
</html> eof
