<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EÄŸitim Takip AsistanÄ± v7 (Full Ã–zellik)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- KÃ¼tÃ¼phaneler -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        button, input[type="file"], select { touch-action: manipulation; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        // --- Ä°KONLAR ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );
        const Upload = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconBase>;
        const FileText = (props) => <IconBase {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></IconBase>;
        const XCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></IconBase>;
        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></IconBase>;
        const User = (props) => <IconBase {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const Filter = (props) => <IconBase {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></IconBase>;
        const ChevronDown = (props) => <IconBase {...props}><polyline points="6 9 12 15 18 9"/></IconBase>;
        const ChevronUp = (props) => <IconBase {...props}><polyline points="18 15 12 9 6 15"/></IconBase>;
        const Loader = (props) => <IconBase {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>;
        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>;
        const Share2 = (props) => <IconBase {...props}><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></IconBase>;
        const Layers = (props) => <IconBase {...props}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></IconBase>;
        const Copy = (props) => <IconBase {...props}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></IconBase>;
        const MessageSquare = (props) => <IconBase {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></IconBase>;
        const ClipboardPaste = (props) => <IconBase {...props}><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></IconBase>;
        const Settings = (props) => <IconBase {...props}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></IconBase>;

        const App = () => {
            const [csvData, setCsvData] = useState([]); // Ham veri
            const [fileName, setFileName] = useState('');
            const [searchName, setSearchName] = useState('');
            const [managerList, setManagerList] = useState([]);
            const [activeTab, setActiveTab] = useState('orientation');
            const [expandedWarehouses, setExpandedWarehouses] = useState({});
            const [loading, setLoading] = useState(false);
            const [downloadingAll, setDownloadingAll] = useState(false);
            const [inputType, setInputType] = useState('upload'); 
            const [pasteContent, setPasteContent] = useState('');
            const [showColumnSettings, setShowColumnSettings] = useState(false);
            const [allHeaders, setAllHeaders] = useState([]);

            // SÃ¼tun EÅŸleÅŸmeleri
            const [colMap, setColMap] = useState({
                sy: '',
                sgs: '',
                warehouse: '',
                orientation: '',
                chat: '',
                name: '',
                phone: ''
            });

            const listRefs = useRef({});

            // --- AKILLI SATIR TESPÄ°TÄ° (PUANLAMA SÄ°STEMÄ°) ---
            const findHeaderRowIndex = (dataArray) => {
                let bestIndex = 0;
                let maxScore = 0;

                for (let i = 0; i < Math.min(dataArray.length, 50); i++) {
                    const row = dataArray[i];
                    if (!row || !Array.isArray(row)) continue;
                    const rowStr = row.join(' ').toLowerCase();
                    
                    let score = 0;
                    // ArtÄ± Puanlar
                    if (rowStr.includes('sy') || rowStr.includes('yÃ¶netici')) score += 5;
                    if (rowStr.includes('sgs') || rowStr.includes('sorumlu')) score += 5;
                    if (rowStr.includes('warehouse') || rowStr.includes('depo')) score += 4;
                    if (rowStr.includes('courier') || rowStr.includes('kurye')) score += 3;
                    if (rowStr.includes('oryantasyon')) score += 3;

                    // Eksi Puanlar
                    if (rowStr.includes('saved by') || rowStr.includes('from:') || rowStr.includes('generated')) score -= 20;
                    
                    if (score > maxScore) {
                        maxScore = score;
                        bestIndex = i;
                    }
                }
                return bestIndex; 
            };

            // --- OTOMATÄ°K SÃœTUN EÅžLEÅžTÄ°RME ---
            const autoMapColumns = (headers) => {
                const lowerHeaders = headers.map(h => String(h).toLowerCase().trim());
                const find = (keywords) => {
                    for (let k of keywords) {
                        const idx = lowerHeaders.findIndex(h => h === k || h.includes(k));
                        if (idx !== -1) return headers[idx];
                    }
                    return '';
                };

                const newMap = {
                    sy: find(['sy', 'saha yÃ¶neticisi', 'saha yoneticisi', 'yÃ¶netici']),
                    sgs: find(['sgs', 'saha sorumlusu', 'sorumlu']),
                    warehouse: find(['warehouse', 'depo', 'depo adÄ±']),
                    orientation: find(['oryantasyon', 'orientation']),
                    chat: find(['Ã¶ÄŸretici sohbetler', 'sohbet', 'chat']),
                    name: find(['courier name', 'kurye adÄ±', 'ad soyad', 'isim']),
                    phone: find(['courier gsm', 'telefon', 'gsm', 'cep'])
                };
                
                setColMap(newMap);
                return newMap;
            };

            // --- YÃ–NETÄ°CÄ° LÄ°STESÄ° Ã‡IKARMA (SÃœPER FÄ°LTRELÄ°) ---
            const updateManagerList = (data, mapping) => {
                if (!data || !data.length) return;
                const managers = new Set();
                
                data.forEach(row => {
                    [mapping.sy, mapping.sgs].forEach(key => {
                        if (key && row[key]) {
                            const val = String(row[key]).trim();
                            const lowerVal = val.toLowerCase();
                            
                            // Ã‡Ã–P VERÄ° FÄ°LTRESÄ°
                            if (
                                val.length > 2 && 
                                val.length < 50 && 
                                !lowerVal.includes('saved by') &&
                                !lowerVal.includes('from:') &&
                                !lowerVal.includes('sidebar') &&
                                !lowerVal.includes('addon') &&
                                !lowerVal.includes('http') &&
                                !lowerVal.includes('www') &&
                                !lowerVal.includes('bilgi yok') &&
                                !lowerVal.includes(':') 
                            ) {
                                managers.add(val);
                            }
                        }
                    });
                });

                setManagerList(Array.from(managers).sort((a, b) => a.localeCompare(b, 'tr')));
            };

            useEffect(() => {
                if (csvData.length > 0) {
                    updateManagerList(csvData, colMap);
                }
            }, [csvData, colMap]);

            const processRawDataArray = (rawData) => {
                try {
                    const headerIdx = findHeaderRowIndex(rawData);
                    const headers = rawData[headerIdx].map(h => h ? String(h).trim() : `SÃ¼tun ${Math.random().toString().substr(2,4)}`);
                    setAllHeaders(headers);

                    const cleanData = [];
                    for (let i = headerIdx + 1; i < rawData.length; i++) {
                        const row = rawData[i];
                        if (!row || row.length === 0) continue;
                        const rowObj = {};
                        headers.forEach((h, idx) => {
                            rowObj[h] = row[idx] !== undefined ? row[idx] : "";
                        });
                        cleanData.push(rowObj);
                    }

                    setCsvData(cleanData);
                    autoMapColumns(headers); 
                    setLoading(false);

                } catch (e) {
                    console.error(e);
                    alert("Veri iÅŸleme hatasÄ±: " + e.message);
                    setLoading(false);
                }
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                setFileName(file.name);
                setLoading(true);
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = window.XLSX.read(data, { type: 'array' });
                        let sheetName = workbook.SheetNames.find(n => n.toLowerCase().includes('rapor')) || workbook.SheetNames[0];
                        const rawData = window.XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
                        processRawDataArray(rawData);
                    } catch (err) {
                        alert("Dosya okunamadÄ±.");
                        setLoading(false);
                    }
                };
                reader.readAsArrayBuffer(file);
                event.target.value = null;
            };

            const handlePasteProcess = () => {
                if (!pasteContent.trim()) return alert("Veri yapÄ±ÅŸtÄ±rÄ±n.");
                setLoading(true);
                setTimeout(() => {
                    try {
                        const rows = pasteContent.trim().split('\n').map(r => r.split(r.includes('\t') ? '\t' : ','));
                        processRawDataArray(rows);
                    } catch(e) { alert("Hata"); setLoading(false); }
                }, 100);
            };

            // --- VERÄ° FÄ°LTRELEME ---
            const processedData = useMemo(() => {
                if (!csvData.length || !searchName) return null;
                const lowerSearch = searchName.toLocaleLowerCase('tr');

                const filtered = csvData.filter(item => {
                    const sy = String(item[colMap.sy] || '').toLocaleLowerCase('tr');
                    const sgs = String(item[colMap.sgs] || '').toLocaleLowerCase('tr');
                    return sy === lowerSearch || sgs === lowerSearch; 
                });

                const grouped = {};
                filtered.forEach(item => {
                    const wh = item[colMap.warehouse] || 'Bilinmeyen Depo';
                    if (!grouped[wh]) grouped[wh] = { total: 0, orientation: { incomplete: [] }, chat: { incomplete: [] } };
                    grouped[wh].total += 1;

                    const orientVal = String(item[colMap.orientation] || '').trim().toLowerCase();
                    if (orientVal !== 'tamamladÄ±') {
                        grouped[wh].orientation.incomplete.push({
                            'Courier Name': item[colMap.name],
                            'Courier Gsm': item[colMap.phone]
                        });
                    }

                    const chatVal = String(item[colMap.chat] || '').trim().toLowerCase();
                    if (chatVal !== 'tamamladÄ±') {
                        grouped[wh].chat.incomplete.push({
                            'Courier Name': item[colMap.name],
                            'Courier Gsm': item[colMap.phone]
                        });
                    }
                });
                return grouped;
            }, [csvData, searchName, colMap]);

            // --- YARDIMCI FONKSÄ°YONLAR ---
            const toggleWarehouse = (w) => setExpandedWarehouses(prev => ({...prev, [w]: !prev[w]}));
            
            const getWhatsappLink = (phone, type) => {
                if (!phone) return '#';
                let p = String(phone).replace(/\D/g, '');
                if (p.startsWith('0')) p = p.substring(1);
                if (p.length === 10) p = '90' + p;
                const m = new Date().toLocaleString('tr-TR', { month: 'long' });
                const t = type === 'orientation' ? 'Oryantasyon' : 'Ã–ÄŸretici Sohbetler';
                return `https://wa.me/${p}?text=${encodeURIComponent(`Merhaba, ${m} ayÄ±na ait ${t} EÄŸitimin eksik gÃ¶rÃ¼nÃ¼yor, tamamlar mÄ±sÄ±n?`)}`;
            };

            // GÃ¶rseli oluÅŸturur ve dÃ¶ndÃ¼rÃ¼r
            const createScreenshot = async (whName) => {
                if (!listRefs.current[whName]) return null;
                const el = listRefs.current[whName];
                const originalBg = el.style.backgroundColor;
                const originalColor = el.style.color;
                
                // GÃ¶rsel iÃ§in net bir stil uygula
                el.style.backgroundColor = "#ffffff";
                el.style.color = "#1e293b";
                el.style.padding = "20px";
                
                try {
                    const canvas = await window.html2canvas(el, { scale: 2, backgroundColor: "#ffffff", useCORS: true });
                    return canvas;
                } finally {
                    // Stilleri geri al
                    el.style.backgroundColor = originalBg;
                    el.style.color = originalColor;
                    el.style.padding = "";
                }
            };

            const getFileName = (whName) => {
                const dateStr = new Date().toLocaleDateString('tr-TR').replace(/\./g, '.');
                const typeStr = activeTab === 'orientation' ? 'Oryantasyon' : 'Ã–ÄŸretici Sohbet';
                return `${whName} - ${typeStr} - ${dateStr}.png`;
            };

            const handleDownloadSingle = async (whName) => {
                const canvas = await createScreenshot(whName);
                if (!canvas) return;
                const link = document.createElement('a');
                link.download = getFileName(whName);
                link.href = canvas.toDataURL('image/png');
                link.click();
            };

            const handleShareText = (whName) => {
                const data = processedData[whName];
                const currentList = activeTab === 'orientation' ? data.orientation.incomplete : data.chat.incomplete;
                if (!currentList || !currentList.length) return;

                const dateStr = new Date().toLocaleDateString('tr-TR');
                const typeStr = activeTab === 'orientation' ? 'Oryantasyon' : 'Ã–ÄŸretici Sohbet';
                let message = `*${whName} - ${typeStr} Eksik Listesi (${dateStr})*\n\n`;
                currentList.forEach((c, i) => message += `${i + 1}. ${c['Courier Name']} (${c['Courier Gsm']})\n`);
                message += `\n*Toplam Eksik:* ${currentList.length} KiÅŸi`;
                window.open(`https://web.whatsapp.com/send?text=${encodeURIComponent(message)}`, '_blank');
            };

            const handleShareImage = async (whName) => {
                const canvas = await createScreenshot(whName);
                if (!canvas) return;
                
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], getFileName(whName), { type: 'image/png' });
                    
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        try { await navigator.share({ files: [file] }); } catch (e) {}
                    } else {
                         try {
                            const item = new ClipboardItem({ 'image/png': blob });
                            await navigator.clipboard.write([item]);
                            if (confirm("GÃ¶rsel panoya kopyalandÄ±! WhatsApp Web aÃ§Ä±lsÄ±n mÄ±? (Ctrl+V ile yapÄ±ÅŸtÄ±rabilirsiniz)")) {
                                window.open("https://web.whatsapp.com", "_blank");
                            }
                        } catch (err) {
                            alert("Otomatik kopyalama yapÄ±lamadÄ±. GÃ¶rsel indiriliyor, manuel gÃ¶nderebilirsiniz.");
                            handleDownloadSingle(whName);
                        }
                    }
                }, 'image/png');
            };

            const downloadAll = async () => {
                if (!processedData) return;
                setDownloadingAll(true);
                const keys = Object.keys(processedData);
                setExpandedWarehouses(keys.reduce((a, k) => ({...a, [k]: true}), {}));
                await new Promise(r => setTimeout(r, 1000)); // Render bekle
                for (const k of keys) {
                    const d = processedData[k];
                    const list = activeTab === 'orientation' ? d.orientation.incomplete : d.chat.incomplete;
                    if (list.length > 0) {
                        await handleDownloadSingle(k);
                        await new Promise(r => setTimeout(r, 500));
                    }
                }
                setDownloadingAll(false);
                alert("TÃ¼m indirmeler tamamlandÄ±!");
            };

            return (
                <div className="min-h-screen bg-slate-50 p-4 font-sans text-slate-800 pb-24">
                    <div className="max-w-5xl mx-auto space-y-6">
                        
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                                <FileText className="text-blue-600" />
                                EÄŸitim Takip AsistanÄ± v7
                            </h1>
                            <p className="text-slate-500 mt-2 text-sm">
                                AkÄ±llÄ± baÅŸlÄ±k tarama, temiz liste ve geliÅŸmiÅŸ paylaÅŸÄ±m seÃ§enekleri.
                            </p>
                        </div>

                        {/* TABLAR */}
                        <div className="flex bg-white rounded-xl p-1 max-w-md mx-auto shadow-sm border">
                            <button onClick={() => setInputType('upload')} className={`flex-1 py-2 text-sm font-medium rounded-lg flex justify-center gap-2 ${inputType === 'upload' ? 'bg-blue-50 text-blue-700' : 'text-slate-500'}`}><Upload size={16}/> Dosya YÃ¼kle</button>
                            <button onClick={() => setInputType('paste')} className={`flex-1 py-2 text-sm font-medium rounded-lg flex justify-center gap-2 ${inputType === 'paste' ? 'bg-green-50 text-green-700' : 'text-slate-500'}`}><ClipboardPaste size={16}/> YapÄ±ÅŸtÄ±r</button>
                        </div>

                        <div className="grid md:grid-cols-2 gap-4">
                            {/* YÃœKLEME ALANI */}
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col items-center justify-center relative min-h-[200px]">
                                {inputType === 'upload' ? (
                                    <div className="w-full h-full relative group cursor-pointer flex flex-col items-center justify-center">
                                        <input type="file" onChange={handleFileUpload} disabled={loading} className="absolute inset-0 w-full h-full opacity-0 z-50 cursor-pointer" />
                                        <div className="text-center p-6 border-2 border-dashed border-slate-200 rounded-xl w-full h-full flex flex-col items-center justify-center group-hover:bg-slate-50 transition-colors">
                                            {loading ? <Loader className="animate-spin text-blue-500 mb-2" size={32}/> : <Upload className="text-blue-500 mb-2" size={32}/>}
                                            <span className="font-medium text-slate-700">{loading ? "Ä°ÅŸleniyor..." : (fileName || "Dosya SeÃ§mek Ä°Ã§in Dokun")}</span>
                                            <span className="text-xs text-slate-400 mt-2 bg-blue-50 px-2 py-1 rounded">Mobil uyumlu yÃ¼kleyici</span>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="w-full">
                                        <textarea className="w-full h-32 p-3 text-xs border rounded-lg mb-2 outline-none focus:ring-2 focus:ring-green-500" placeholder="Veriyi buraya yapÄ±ÅŸtÄ±r..." value={pasteContent} onChange={e => setPasteContent(e.target.value)}></textarea>
                                        <button onClick={handlePasteProcess} disabled={loading} className="w-full bg-green-600 text-white py-2 rounded-lg text-sm font-bold">Veriyi Ä°ÅŸle</button>
                                    </div>
                                )}
                            </div>

                            {/* YÃ–NETÄ°CÄ° SEÃ‡Ä°MÄ° VE AYARLAR */}
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-center">
                                <div className="flex justify-between items-center mb-2">
                                    <label className="text-sm font-medium text-slate-600 flex items-center gap-2"><User size={16} /> YÃ¶netici SeÃ§iniz</label>
                                    {csvData.length > 0 && (
                                        <button onClick={() => setShowColumnSettings(!showColumnSettings)} className="text-xs text-blue-600 hover:underline flex items-center gap-1">
                                            <Settings size={12}/> SÃ¼tunlarÄ± DÃ¼zenle
                                        </button>
                                    )}
                                </div>
                                
                                {showColumnSettings && (
                                    <div className="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-100 text-xs space-y-2 animate-fade-in">
                                        <p className="font-bold text-blue-800">SÃ¼tun EÅŸleÅŸtirmeleri (Hata varsa dÃ¼zeltin)</p>
                                        {[
                                            {k:'sy', l:'SY / YÃ¶netici'}, {k:'sgs', l:'SGS / Sorumlu'}, 
                                            {k:'warehouse', l:'Depo AdÄ±'}, {k:'name', l:'Kurye AdÄ±'}, 
                                            {k:'phone', l:'Telefon'}, {k:'orientation', l:'Oryantasyon'}, 
                                            {k:'chat', l:'Sohbet'}
                                        ].map(field => (
                                            <div key={field.k} className="flex flex-col">
                                                <label className="text-blue-600 mb-1">{field.l}</label>
                                                <select 
                                                    value={colMap[field.k]} 
                                                    onChange={(e) => setColMap({...colMap, [field.k]: e.target.value})}
                                                    className="p-2 border rounded bg-white"
                                                >
                                                    <option value="">SeÃ§ilmedi</option>
                                                    {allHeaders.map((h, i) => <option key={i} value={h}>{h}</option>)}
                                                </select>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                <div className="relative">
                                    <select value={searchName} onChange={e => setSearchName(e.target.value)} disabled={!managerList.length} className="w-full pl-10 pr-8 py-3 bg-slate-50 border rounded-lg appearance-none outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">{managerList.length ? "Listeden SeÃ§iniz..." : "Ã–nce Dosya YÃ¼kleyin"}</option>
                                        {managerList.map((m, i) => <option key={i} value={m}>{m}</option>)}
                                    </select>
                                    <Search className="absolute left-3 top-3.5 text-slate-400 w-5 h-5" />
                                    <ChevronDown className="absolute right-3 top-3.5 text-slate-400 w-5 h-5" />
                                </div>
                                {managerList.length > 0 && !searchName && <p className="text-xs text-red-500 mt-2 font-bold animate-pulse">ðŸ‘† LÃ¼tfen isminizi seÃ§in!</p>}
                            </div>
                        </div>

                        {/* SONUÃ‡LAR */}
                        {processedData && Object.keys(processedData).length > 0 ? (
                            <div className="space-y-4 animate-fade-in">
                                <div className="flex p-1 bg-white rounded-lg border w-fit mx-auto md:mx-0">
                                    <button onClick={() => setActiveTab('orientation')} className={`px-4 md:px-6 py-2 rounded-md text-sm font-medium ${activeTab === 'orientation' ? 'bg-blue-100 text-blue-700' : 'text-slate-500'}`}>Oryantasyon</button>
                                    <button onClick={() => setActiveTab('chat')} className={`px-4 md:px-6 py-2 rounded-md text-sm font-medium ${activeTab === 'chat' ? 'bg-purple-100 text-purple-700' : 'text-slate-500'}`}>Ã–ÄŸretici Sohbetler</button>
                                </div>

                                {Object.entries(processedData).map(([whName, data]) => {
                                    const currentData = activeTab === 'orientation' ? data.orientation : data.chat;
                                    const expanded = expandedWarehouses[whName];
                                    const theme = activeTab === 'orientation' ? 'text-blue-700 bg-blue-50' : 'text-purple-700 bg-purple-50';

                                    return (
                                        <div key={whName} className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                            <div onClick={() => toggleWarehouse(whName)} className="p-4 flex items-center justify-between cursor-pointer hover:bg-slate-50">
                                                <div className="flex items-center gap-3">
                                                    <div className={`p-2 rounded-lg ${theme}`}><Filter size={18} /></div>
                                                    <div>
                                                        <h3 className="font-bold text-slate-800 text-sm md:text-base">{whName}</h3>
                                                        <p className="text-xs text-slate-500">Eksik: <span className="font-bold text-red-600">{currentData.incomplete.length}</span></p>
                                                    </div>
                                                </div>
                                                {expanded ? <ChevronUp className="text-slate-400"/> : <ChevronDown className="text-slate-400"/>}
                                            </div>

                                            {expanded && (
                                                <div className="border-t border-slate-100 bg-slate-50/50 p-4">
                                                    {/* Capture Area */}
                                                    <div ref={el => listRefs.current[whName] = el} className="bg-white p-4 md:p-6 rounded-lg border border-red-200 shadow-sm max-w-2xl mx-auto mb-4">
                                                        <div className="mb-4 border-b border-red-100 pb-3">
                                                            <div className="flex justify-between items-center"><h4 className="font-bold text-lg text-slate-800">{whName}</h4><span className="text-xs text-slate-500">{new Date().toLocaleDateString('tr-TR')}</span></div>
                                                            <h5 className={`font-semibold text-sm flex items-center gap-2 ${activeTab === 'orientation' ? 'text-blue-700' : 'text-purple-700'}`}><XCircle size={16} className="text-red-500"/> {activeTab === 'orientation' ? 'Oryantasyon Eksik' : 'Sohbet Eksik'}</h5>
                                                        </div>
                                                        <ul className="space-y-2">
                                                            {currentData.incomplete.map((c, i) => (
                                                                <li key={i} className="text-sm text-slate-700 bg-red-50 p-2 md:p-3 rounded flex justify-between items-center border border-red-100">
                                                                    <span className="font-semibold text-xs md:text-sm">{c['Courier Name']}</span>
                                                                    <a href={getWhatsappLink(c['Courier Gsm'], activeTab)} target="_blank" className="text-green-600 bg-white px-2 py-1 rounded border border-green-200 text-xs font-mono flex items-center gap-1 no-underline"><MessageSquare size={12}/> {c['Courier Gsm']}</a>
                                                                </li>
                                                            ))}
                                                            {currentData.incomplete.length === 0 && <li className="text-center py-4 text-green-600 bg-green-50 rounded font-medium text-sm">Herkes tamamladÄ±! ðŸŽ‰</li>}
                                                        </ul>
                                                    </div>
                                                    
                                                    {/* Action Buttons */}
                                                    {currentData.incomplete.length > 0 && (
                                                        <div className="flex justify-center gap-2 flex-wrap">
                                                            <button onClick={() => handleShareText(whName)} className="bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-sm flex items-center gap-2 hover:bg-green-600 transition-colors"><MessageSquare size={16}/> Liste YazÄ±</button>
                                                            
                                                            <button onClick={() => handleShareImage(whName)} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-sm flex items-center gap-2 hover:bg-blue-700 transition-colors">
                                                                <Copy size={16}/> 
                                                                <span className="hidden sm:inline">GÃ¶rsel Kopyala</span>
                                                                <span className="sm:hidden">GÃ¶rsel</span>
                                                            </button>

                                                            <button onClick={() => handleDownloadSingle(whName)} className="bg-white border border-slate-300 text-slate-600 px-3 py-2 rounded-lg shadow-sm hover:bg-slate-50 transition-colors"><Download size={16}/></button>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                                
                                <div className="fixed bottom-6 left-0 right-0 flex justify-center pointer-events-none z-50">
                                    <div className="bg-white p-2 rounded-full shadow-lg border pointer-events-auto">
                                        <button onClick={downloadAll} disabled={downloadingAll} className="bg-slate-800 text-white px-6 py-3 rounded-full font-bold flex items-center gap-2 shadow-md">
                                            {downloadingAll ? <Loader className="animate-spin"/> : <Layers size={20}/>} TÃ¼mÃ¼nÃ¼ Ä°ndir
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ) : null}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
