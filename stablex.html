<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EÄŸitim Takip AsistanÄ± v24.5 (Final Fix)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- KÃ¼tÃ¼phaneler -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Font (Getir Fontuna Benzer) -->
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">

    <!-- AYARLAR -->
    <script>
        window.DEFAULT_SHEET_URL = "https://docs.google.com/spreadsheets/d/1e6anRqSJmDIBXwJAvyust3ROpNPtFMaTm92renU40HQ/edit?usp=sharing"; 
    </script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        button, input[type="file"], select, input[type="text"] { touch-action: manipulation; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .animate-scale-in { animation: scaleIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        
        /* Ã–zel Font SÄ±nÄ±fÄ± */
        .font-getir { font-family: 'Varela Round', sans-serif; letter-spacing: -3px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        // --- GÃœVENLÄ° GÃ–RSEL BÄ°LEÅžENLERÄ° (INLINE SVG) ---
        // Bu yÃ¶ntem resim yÃ¼klemediÄŸi iÃ§in beyaz ekran hatasÄ± vermez.

        // 1. Getir YazÄ± Logosu (SarÄ±)
        const GetirTextLogo = () => (
            <div className="font-getir font-bold tracking-tighter" 
                 style={{ 
                     color: '#ffd10d', 
                     fontSize: '80px', 
                     lineHeight: '1', 
                     textAlign: 'center', 
                     width: '100%',
                     textShadow: '2px 2px 4px rgba(0,0,0,0.1)' 
                 }}>
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/58/Getir_logo.png/120px-Getir_logo.png"/>
            </div>
        );

        // 2. GÃ¼venlik EkipmanlarÄ± Deseni (Hologram Arka Plan)
        const SafetyGearPattern = ({ style }) => (
            <svg style={style} xmlns="http://www.w3.org/2000/svg" width="100%" height="100%">
                <defs>
                    <pattern id="gearPattern" x="0" y="0" width="150" height="150" patternUnits="userSpaceOnUse" patternTransform="rotate(-20)">
                        {/* Kask */}
                        <path d="M40 30c-8.8 0-16 7.2-16 16 0 6.6 4.1 12.2 10 14.6V64h12v-3.4c5.9-2.4 10-8 10-14.6 0-8.8-7.2-16-16-16zm0 24c-4.4 0-8-3.6-8-8h16c0 4.4-3.6 8-8 8z" fill="#ffffff" opacity="0.15" transform="scale(1.2) translate(0, 0)"/>
                        {/* Mont/Yelek */}
                        <path d="M100 30l-10 10v20h4v-16l6-6h20l6 6v16h4V40l-10-10H100z" fill="#ffffff" opacity="0.15" transform="scale(1.2) translate(0, 0)"/>
                    </pattern>
                </defs>
                <rect width="100%" height="100%" fill="url(#gearPattern)" />
            </svg>
        );

        // --- Ä°KONLAR ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );
        const Upload = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconBase>;
        const FileUp = (props) => <IconBase {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="12" y2="12"/><line x1="15" y1="15" x2="12" y2="12"/></IconBase>;
        const FileText = (props) => <IconBase {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></IconBase>;
        const XCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></IconBase>;
        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></IconBase>;
        const User = (props) => <IconBase {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const Filter = (props) => <IconBase {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></IconBase>;
        const ChevronDown = (props) => <IconBase {...props}><polyline points="6 9 12 15 18 9"/></IconBase>;
        const ChevronUp = (props) => <IconBase {...props}><polyline points="18 15 12 9 6 15"/></IconBase>;
        const Loader = (props) => <IconBase {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>;
        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>;
        const Share2 = (props) => <IconBase {...props}><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></IconBase>;
        const Layers = (props) => <IconBase {...props}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></IconBase>;
        const Copy = (props) => <IconBase {...props}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></IconBase>;
        const MessageSquare = (props) => <IconBase {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></IconBase>;
        const ClipboardPaste = (props) => <IconBase {...props}><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></IconBase>;
        const Settings = (props) => <IconBase {...props}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></IconBase>;
        const PhoneIcon = (props) => <IconBase {...props}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>;
        const Check = (props) => <IconBase {...props}><polyline points="20 6 9 17 4 12"/></IconBase>;

        const App = () => {
            const [csvData, setCsvData] = useState([]);
            const [fileName, setFileName] = useState('');
            const [searchName, setSearchName] = useState('');
            const [managerList, setManagerList] = useState([]);
            const [activeTab, setActiveTab] = useState('orientation');
            const [expandedWarehouses, setExpandedWarehouses] = useState({});
            const [loading, setLoading] = useState(false);
            const [downloadingAll, setDownloadingAll] = useState(false);
            const [inputType, setInputType] = useState('upload'); 
            const [pasteContent, setPasteContent] = useState('');
            const [showColumnSettings, setShowColumnSettings] = useState(false);
            const [allHeaders, setAllHeaders] = useState([]);
            const [targetPhone, setTargetPhone] = useState('');
            const [isAutoLoaded, setIsAutoLoaded] = useState(false);
            const [hasError, setHasError] = useState(false);
            
            // --- EÄžÄ°TÄ°M BÄ°LGÄ°LERÄ° ---
            const [chatSettings, setChatSettings] = useState({ id: '', name: '' });
            const [colMap, setColMap] = useState({ sy: '', sgs: '', warehouse: '', orientation: '', chat: '', name: '', phone: '' });
            const listRefs = useRef({});

            useEffect(() => {
                const savedPhone = localStorage.getItem('targetPhone');
                if (savedPhone) setTargetPhone(savedPhone);
                const savedChat = localStorage.getItem('chatSettings');
                if (savedChat) setChatSettings(JSON.parse(savedChat));
                
                fetch('id.txt')
                    .then(res => { if(res.ok) return res.text(); throw new Error('Dosya yok'); })
                    .then(text => { parseIdContent(text, true); })
                    .catch(err => console.log("Otomatik id.txt bulunamadÄ±"));
            }, []);

            const saveTargetPhone = (e) => {
                const val = e.target.value;
                setTargetPhone(val);
                localStorage.setItem('targetPhone', val);
            };

            const parseIdContent = (text, isAuto = false) => {
                const lines = text.split('\n').map(l => l.trim()).filter(l => l);
                let foundId = '', foundName = '';
                lines.forEach(line => {
                    const lower = line.toLowerCase();
                    if (lower.startsWith('id:') || lower.startsWith('id=')) foundId = line.split(/[:=]/)[1].trim();
                    else if (lower.startsWith('isim:') || lower.startsWith('name:')) foundName = line.split(/[:=]/)[1].trim();
                });
                if (!foundId && !foundName && lines.length >= 2) { foundId = lines[0]; foundName = lines[1]; }
                
                if (foundId || foundName) {
                    const newSettings = { id: foundId, name: foundName };
                    setChatSettings(newSettings);
                    localStorage.setItem('chatSettings', JSON.stringify(newSettings));
                    if (isAuto) setIsAutoLoaded(true);
                    if (!isAuto) alert(`âœ… Bilgiler YÃ¼klendi!\nID: ${foundId}\nÄ°sim: ${foundName}`);
                } else if (!isAuto) alert("Veri okunamadÄ±.");
            };

            const handleIdFile = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => parseIdContent(event.target.result, false);
                reader.readAsText(file);
                e.target.value = null; 
            };

            const findHeaderRowIndex = (dataArray) => {
                let bestIndex = 0, maxScore = 0;
                for (let i = 0; i < Math.min(dataArray.length, 50); i++) {
                    const row = dataArray[i];
                    if (!row || !Array.isArray(row)) continue;
                    const rowStr = row.join(' ').toLowerCase();
                    let score = 0;
                    if (rowStr.includes('sy') || rowStr.includes('yÃ¶netici')) score += 5;
                    if (rowStr.includes('sgs') || rowStr.includes('sorumlu')) score += 5;
                    if (rowStr.includes('warehouse') || rowStr.includes('depo')) score += 4;
                    if (rowStr.includes('courier')) score += 3;
                    if (score > maxScore) { maxScore = score; bestIndex = i; }
                }
                return bestIndex; 
            };

            const autoMapColumns = (headers) => {
                const lowerHeaders = headers.map(h => String(h).toLowerCase().trim());
                const find = (keywords) => {
                    for (let k of keywords) {
                        const idx = lowerHeaders.findIndex(h => h === k || h.includes(k));
                        if (idx !== -1) return headers[idx];
                    }
                    return '';
                };
                setColMap({
                    sy: find(['sy', 'saha yÃ¶neticisi']),
                    sgs: find(['sgs', 'saha sorumlusu']),
                    warehouse: find(['warehouse', 'depo']),
                    orientation: find(['oryantasyon']),
                    chat: find(['Ã¶ÄŸretici sohbetler', 'sohbet']),
                    name: find(['courier name', 'kurye adÄ±']),
                    phone: find(['courier gsm', 'telefon'])
                });
            };

            const updateManagerList = (data, mapping) => {
                if (!data || !data.length) return;
                const managers = new Set();
                data.forEach(row => {
                    [mapping.sy, mapping.sgs].forEach(key => {
                        if (key && row[key]) {
                            const val = String(row[key]).trim();
                            if (val.length > 2 && val.length < 50 && !val.toLowerCase().includes('saved by')) managers.add(val);
                        }
                    });
                });
                setManagerList(Array.from(managers).sort((a, b) => a.localeCompare(b, 'tr')));
            };

            useEffect(() => { if (csvData.length > 0) updateManagerList(csvData, colMap); }, [csvData, colMap]);

            const processRawDataArray = (rawData) => {
                try {
                    const headerIdx = findHeaderRowIndex(rawData);
                    const headers = rawData[headerIdx].map(h => h ? String(h).trim() : `SÃ¼tun`);
                    setAllHeaders(headers);
                    const cleanData = [];
                    for (let i = headerIdx + 1; i < rawData.length; i++) {
                        const row = rawData[i];
                        if (!row || row.length === 0) continue;
                        const rowObj = {};
                        headers.forEach((h, idx) => { rowObj[h] = row[idx] !== undefined ? row[idx] : ""; });
                        cleanData.push(rowObj);
                    }
                    setCsvData(cleanData);
                    autoMapColumns(headers); 
                    setLoading(false);
                } catch (e) { alert("Veri hatasÄ±."); setLoading(false); }
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                setFileName(file.name);
                setLoading(true);
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const workbook = window.XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                        let sheetName = workbook.SheetNames.find(n => n.toLowerCase().includes('rapor')) || workbook.SheetNames[0];
                        processRawDataArray(window.XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 }));
                    } catch (err) { alert("Dosya okunamadÄ±."); setLoading(false); }
                };
                reader.readAsArrayBuffer(file);
                event.target.value = null;
            };

            const handlePasteProcess = () => {
                if (!pasteContent.trim()) return alert("Veri yapÄ±ÅŸtÄ±rÄ±n.");
                setLoading(true);
                setTimeout(() => {
                    try {
                        const rows = pasteContent.trim().split('\n').map(r => r.split(r.includes('\t') ? '\t' : ','));
                        processRawDataArray(rows);
                    } catch(e) { alert("Hata"); setLoading(false); }
                }, 100);
            };

            const processedData = useMemo(() => {
                if (!csvData.length || !searchName) return null;
                const lowerSearch = searchName.toLocaleLowerCase('tr');
                const filtered = csvData.filter(item => {
                    const sy = String(item[colMap.sy] || '').toLocaleLowerCase('tr');
                    const sgs = String(item[colMap.sgs] || '').toLocaleLowerCase('tr');
                    return sy === lowerSearch || sgs === lowerSearch; 
                });
                const grouped = {};
                filtered.forEach(item => {
                    const wh = item[colMap.warehouse] || 'Bilinmeyen Depo';
                    if (!grouped[wh]) grouped[wh] = { total: 0, orientation: { incomplete: [] }, chat: { incomplete: [] } };
                    grouped[wh].total += 1;
                    
                    const rawOrientVal = String(item[colMap.orientation] || '').trim().toLowerCase();
                    if (rawOrientVal !== 'tamamladÄ±') grouped[wh].orientation.incomplete.push({
                        'Courier Name': item[colMap.name], 'Courier Gsm': item[colMap.phone], 'isBlank': rawOrientVal === '' || rawOrientVal === '-'
                    });

                    const rawChatVal = String(item[colMap.chat] || '').trim().toLowerCase();
                    if (rawChatVal !== 'tamamladÄ±') grouped[wh].chat.incomplete.push({
                        'Courier Name': item[colMap.name], 'Courier Gsm': item[colMap.phone], 'isBlank': rawChatVal === '' || rawChatVal === '-'
                    });
                });
                return grouped;
            }, [csvData, searchName, colMap]);

            const toggleWarehouse = (w) => setExpandedWarehouses(prev => ({...prev, [w]: !prev[w]}));
            
            const getWhatsappLink = (phone, type, name = '') => {
                if (!phone) return '#';
                let p = String(phone).replace(/\D/g, '');
                if (p.startsWith('0')) p = p.substring(1);
                if (p.length === 10) p = '90' + p;
                
                let message = "";
                if (type === 'orientation') {
                    message = `Merhaba ${name},
Kurye oryantasyon eÄŸitimin sistemde hala bitmemiÅŸ gÃ¶rÃ¼nÃ¼yor. Senden ricam eÄŸitimini tamamlaman. Bitirdikten sonra ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ benimle paylaÅŸÄ±rsan sevinirim. Kurye oryantasyon eÄŸitim linkini aÅŸaÄŸÄ±ya bÄ±rakÄ±yorum.GÃ¼venli sÃ¼rÃ¼ÅŸler dilerim.

https://www.getirup.com/getirup/eep/main/activity/3740

Kullanici adÄ±n: ${p.substring(2)} (BaÅŸÄ±nda 0 olmadan numaran)
Åžifreni bilmiyorsan veya hatÄ±rlamÄ±yorsam gÃ¶nderdiÄŸim linkten parolami unuttum diyerek yeni ÅŸifre talebinde bulabilirsin.

Kullanici adÄ± ve ÅŸifrede almada sorun yaÅŸarsan ayrÄ±ca bana yazabilirsin yardÄ±mcÄ± olurum.

MDU Ã¼zerinden giriÅŸ yapmak isteyen arkadaÅŸlarÄ±mÄ±z Google Play Store Ã¼zerinden E Mobil Plus uygulamasÄ±nÄ± indirdikten sonra MDU Ã¼zerinden Profilim sekmesi Ã¼zerinden GetirUp linkine tÄ±klayÄ±p kullanÄ±cÄ± adÄ± ve ÅŸifre bilgisi olmadan doÄŸrudan giriÅŸ yapabilir.

E Mobil Plus linki ; https://play.google.com/store/apps/details?id=com.enocta.emobilplus&hl=tr&pli=1`;
                } else {
                    const currentMonth = new Date().toLocaleString('tr-TR', { month: 'long' });
                    const chatName = chatSettings.name || '[EÄŸitim Ä°smi]';
                    const chatId = chatSettings.id || '[ID]';
                    message = `Merhaba ${name},
* ${currentMonth} AyÄ± Ã–ÄŸretici Sohbetler yayÄ±nda! *ðŸš€ðŸ’¡

ðŸ“£${currentMonth} AyÄ± Ã–ÄŸretici Sohbetler "${chatName}" adlÄ± videoya aÅŸaÄŸÄ±daki linkten ulaÅŸabilirsiniz. GÃ¼venli sÃ¼rÃ¼ÅŸler

https://www.getirup.com/getirup/eep/main/activity/${chatId}

GiriÅŸ YÃ¶ntemleriðŸš¨
ðŸ“ŽE.mobil uygulamasÄ± telefon yÃ¼klÃ¼ olmalÄ±. ( Google Play Store iÃ§erisinde mevcut. )SonrasÄ±nda MDUâ€™ya giriÅŸ yapÄ±n ve profil bÃ¶lÃ¼mÃ¼nde Getirupâ€™Ä± tÄ±klayÄ±n. Åžifresiz giriÅŸ yapabilirsiniz

Yada

ðŸ“ŽE.Mobil uygulamasÄ±na giriÅŸ yaparak ulaÅŸabilirsiniz.
Kurum Kodu: GETIRUP
KullanÄ±cÄ± adÄ±: ${p.substring(2)} (BaÅŸÄ±nda 0 olmadan)
ParolamÄ± unuttum diyerek yeni parola oluÅŸturabilirsiniz.

EÄŸitimi tamamlayÄ±p ekran gÃ¶rÃ¼ntÃ¼sÃ¼ paylaÅŸmanÄ±zÄ± rica ediyorum.`;
                }
                return `https://wa.me/${p}?text=${encodeURIComponent(message)}`;
            };

            const createScreenshot = async (whName) => {
                if (!listRefs.current[whName]) return null;
                const el = listRefs.current[whName];
                const originalBg = el.style.backgroundColor;
                const originalColor = el.style.color;
                const originalPadding = el.style.padding;
                const originalBorderRadius = el.style.borderRadius;
                
                // Ä°konlarÄ± gizle
                const icons = el.querySelectorAll('.hide-on-capture');
                icons.forEach(i => i.style.display = 'none');
                
                // GÃ¶rselleri gÃ¶rÃ¼nÃ¼r yap
                const captureElements = el.querySelectorAll('.show-on-capture');
                captureElements.forEach(b => b.style.display = 'block');

                // Telefon NumaralarÄ±nÄ± GÄ°ZLE
                const links = el.querySelectorAll('li > a');
                links.forEach(a => a.style.display = 'none');

                // STÄ°L AYARLARI
                el.style.backgroundColor = "#5d3ebc"; 
                el.style.color = "#ffd10d"; 
                el.style.padding = "60px 30px 30px 30px";
                el.style.borderRadius = "0px";
                el.style.position = "relative"; 
                
                // Liste elemanlarÄ± (Beyaz kutu)
                const listItems = el.querySelectorAll('li');
                listItems.forEach(li => {
                    li.style.backgroundColor = "white";
                    li.style.color = "#44546a"; 
                    li.style.fontWeight = "bold";
                    li.style.border = "2px solid #f29b26"; 
                    li.style.marginBottom = "8px";
                    li.style.borderRadius = "8px";
                    li.style.padding = "10px 15px";
                    // ORTALA
                    li.style.justifyContent = "center"; 
                    li.style.textAlign = "center";
                });
                
                // BaÅŸlÄ±klar
                const headers = el.querySelectorAll('h4, h5, p, span, div');
                headers.forEach(h => {
                    if(!h.closest('li')) { 
                        h.style.color = "#ffd10d"; 
                        if(h.classList.contains('text-slate-500')) h.style.color = "#ffd10d";
                        if(h.classList.contains('text-blue-600')) h.style.color = "#ffd10d";
                        if(h.classList.contains('text-purple-700')) h.style.color = "#ffd10d";
                    } else {
                        // Liste iÃ§i isim rengi
                         h.style.color = "#44546a";
                    }
                    
                    // BÃœYÃœK VE KALIN TARÄ°H
                    if (h.classList.contains('date-label')) {
                        h.style.fontSize = '24px'; 
                        h.style.fontWeight = '900'; 
                    }
                });

                // Render bekle
                await new Promise(r => setTimeout(r, 200));

                try {
                    const canvas = await window.html2canvas(el, { 
                        scale: 2, 
                        backgroundColor: "#5d3ebc", 
                        useCORS: true,
                        logging: false
                    });
                    return canvas;
                } catch(e) {
                    console.error("Canvas hatasÄ±:", e);
                    setHasError(true);
                    return null;
                } finally {
                    el.style.backgroundColor = originalBg;
                    el.style.color = originalColor;
                    el.style.padding = originalPadding;
                    el.style.borderRadius = originalBorderRadius;
                    
                    icons.forEach(i => i.style.display = '');
                    captureElements.forEach(b => b.style.display = 'none');
                    links.forEach(a => a.style.display = ''); // NumaralarÄ± geri getir

                    listItems.forEach(li => {
                        li.style.backgroundColor = ""; 
                        li.style.color = "";
                        li.style.fontWeight = "";
                        li.style.border = "";
                        li.style.marginBottom = "";
                        li.style.borderRadius = "";
                        li.style.padding = "";
                        li.style.justifyContent = "";
                        li.style.textAlign = "";
                    });

                    headers.forEach(h => {
                        h.style.color = "";
                        if (h.classList.contains('date-label')) {
                             h.style.fontSize = "";
                             h.style.fontWeight = "";
                        }
                    });
                }
            };

            const getFileName = (whName) => {
                const dateStr = new Date().toLocaleDateString('tr-TR').replace(/\./g, '.');
                const typeStr = activeTab === 'orientation' ? 'Oryantasyon' : 'Ã–ÄŸretici Sohbet';
                return `${whName} - ${typeStr} - ${dateStr}.png`;
            };

            const handleDownloadSingle = async (whName) => {
                const canvas = await createScreenshot(whName);
                if (!canvas) return;
                const link = document.createElement('a');
                link.download = getFileName(whName);
                link.href = canvas.toDataURL('image/png');
                link.click();
            };

            const downloadAll = async () => {
                if (!processedData) return;
                setDownloadingAll(true);
                const keys = Object.keys(processedData);
                setExpandedWarehouses(keys.reduce((a, k) => ({...a, [k]: true}), {}));
                await new Promise(r => setTimeout(r, 1000));
                for (const k of keys) {
                    const d = processedData[k];
                    const list = activeTab === 'orientation' ? d.orientation.incomplete : d.chat.incomplete;
                    if (list.length > 0) {
                        await handleDownloadSingle(k);
                        await new Promise(r => setTimeout(r, 500));
                    }
                }
                setDownloadingAll(false);
                alert("TÃ¼m indirmeler tamamlandÄ±!");
            };

            const currentMonth = new Date().toLocaleString('tr-TR', { month: 'long' });

            if (hasError) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-red-50 p-4 text-center">
                        <div>
                            <h1 className="text-2xl font-bold text-red-600 mb-2">Bir Hata OluÅŸtu!</h1>
                            <p className="text-slate-600 mb-4">GÃ¶rsel oluÅŸturulurken bir sorun Ã§Ä±ktÄ±. SayfayÄ± yenileyip tekrar deneyin.</p>
                            <button onClick={() => window.location.reload()} className="bg-red-600 text-white px-6 py-2 rounded-lg">Yenile</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50 p-4 font-sans text-slate-800 pb-24">
                    <div className="max-w-5xl mx-auto space-y-6">
                        
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                                <FileText className="text-blue-600" />
                                EÄŸitim Takip AsistanÄ± v24.5 (Stabil)
                            </h1>
                            <p className="text-slate-500 mt-2 text-sm">
                                HÄ±zlÄ± ve otomatik raporlama asistanÄ±.
                            </p>
                        </div>

                        {/* TABLAR */}
                        <div className="flex bg-white rounded-xl p-1 max-w-md mx-auto shadow-sm border">
                            <button onClick={() => setActiveTab('orientation')} className={`flex-1 py-2 text-sm font-medium rounded-lg flex justify-center gap-2 transition-colors ${activeTab === 'orientation' ? 'bg-blue-100 text-blue-700' : 'text-slate-500 hover:text-slate-700'}`}>Oryantasyon</button>
                            <button onClick={() => setActiveTab('chat')} className={`flex-1 py-2 text-sm font-medium rounded-lg flex justify-center gap-2 transition-colors ${activeTab === 'chat' ? 'bg-purple-100 text-purple-700' : 'text-slate-500 hover:text-slate-700'}`}>Ã–ÄŸretici Sohbetler</button>
                        </div>

                        {/* EÄžÄ°TÄ°M BÄ°LGÄ° GÄ°RÄ°ÅžÄ° */}
                        {activeTab === 'chat' && (
                            <div className="bg-purple-50 p-4 rounded-xl border border-purple-100 animate-fade-in relative">
                                <div className="flex justify-between items-center mb-2">
                                    <h3 className="font-bold text-purple-800 flex items-center gap-2"><FileUp size={16}/> EÄŸitim Bilgileri</h3>
                                    <div className="relative">
                                        <button className="text-xs bg-white px-3 py-1.5 rounded border border-purple-200 text-purple-700 hover:bg-purple-100 font-medium flex items-center gap-1">
                                            <Upload size={12}/> Bilgi DosyasÄ± YÃ¼kle (.txt)
                                        </button>
                                        <input type="file" accept=".txt" onChange={handleIdFile} className="absolute inset-0 opacity-0 cursor-pointer w-full h-full" title="id.txt YÃ¼kle"/>
                                    </div>
                                </div>
                                {chatSettings.id && chatSettings.name && (
                                    <div className="bg-white px-3 py-2 rounded border border-purple-200 text-xs text-purple-700 flex items-center gap-2">
                                        {isAutoLoaded ? <span className="bg-purple-100 text-purple-800 px-1 rounded text-[10px] font-bold">OTOMATÄ°K</span> : <Check size={14} className="text-green-500"/>}
                                        <span>YÃ¼klÃ¼: <strong>{chatSettings.name}</strong> (ID: {chatSettings.id})</span>
                                    </div>
                                )}
                            </div>
                        )}

                        <div className="grid md:grid-cols-2 gap-4">
                            {/* YÃœKLEME ALANI */}
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col items-center justify-center relative min-h-[200px]">
                                {inputType === 'upload' ? (
                                    <div className="w-full h-full relative group cursor-pointer flex flex-col items-center justify-center">
                                        <input type="file" onChange={handleFileUpload} disabled={loading} className="absolute inset-0 w-full h-full opacity-0 z-50 cursor-pointer" />
                                        <div className="text-center p-6 border-2 border-dashed border-slate-200 rounded-xl w-full h-full flex flex-col items-center justify-center group-hover:bg-slate-50 transition-colors">
                                            {loading ? <Loader className="animate-spin text-blue-500 mb-2" size={32}/> : <Upload className="text-blue-500 mb-2" size={32}/>}
                                            <span className="font-medium text-slate-700">{loading ? "Ä°ÅŸleniyor..." : (fileName || "Dosya SeÃ§mek Ä°Ã§in Dokun")}</span>
                                            <span className="text-xs text-slate-400 mt-2 bg-blue-50 px-2 py-1 rounded">Mobil uyumlu yÃ¼kleyici</span>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="w-full">
                                        <textarea className="w-full h-32 p-3 text-xs border rounded-lg mb-2 outline-none focus:ring-2 focus:ring-green-500" placeholder="Veriyi buraya yapÄ±ÅŸtÄ±r..." value={pasteContent} onChange={e => setPasteContent(e.target.value)}></textarea>
                                        <button onClick={handlePasteProcess} disabled={loading} className="w-full bg-green-600 text-white py-2 rounded-lg text-sm font-bold">Veriyi Ä°ÅŸle</button>
                                    </div>
                                )}
                                <div className="absolute top-2 right-2 flex gap-2">
                                    <button onClick={() => setInputType('upload')} className={`p-1 rounded ${inputType === 'upload' ? 'bg-slate-200' : 'text-slate-400'}`}><Upload size={14}/></button>
                                    <button onClick={() => setInputType('paste')} className={`p-1 rounded ${inputType === 'paste' ? 'bg-slate-200' : 'text-slate-400'}`}><ClipboardPaste size={14}/></button>
                                </div>
                            </div>

                            {/* YÃ–NETÄ°CÄ° SEÃ‡Ä°MÄ° VE AYARLAR */}
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-center">
                                <div className="flex justify-between items-center mb-2">
                                    <label className="text-sm font-medium text-slate-600 flex items-center gap-2"><User size={16} /> YÃ¶netici SeÃ§iniz</label>
                                    {csvData.length > 0 && (
                                        <button onClick={() => setShowColumnSettings(!showColumnSettings)} className="text-xs text-blue-600 hover:underline flex items-center gap-1">
                                            <Settings size={12}/> SÃ¼tunlarÄ± DÃ¼zenle
                                        </button>
                                    )}
                                </div>
                                {showColumnSettings && (
                                    <div className="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-100 text-xs space-y-2 animate-fade-in">
                                        <p className="font-bold text-blue-800">SÃ¼tun EÅŸleÅŸtirmeleri</p>
                                        {['sy', 'sgs', 'warehouse', 'name', 'phone', 'orientation', 'chat'].map(k => (
                                            <div key={k} className="flex flex-col">
                                                <label className="text-blue-600 mb-1 uppercase">{k}</label>
                                                <select value={colMap[k]} onChange={(e) => setColMap({...colMap, [k]: e.target.value})} className="p-2 border rounded bg-white">
                                                    <option value="">SeÃ§ilmedi</option>
                                                    {allHeaders.map((h, i) => <option key={i} value={h}>{h}</option>)}
                                                </select>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                <div className="relative mb-3">
                                    <select value={searchName} onChange={e => setSearchName(e.target.value)} disabled={!managerList.length} className="w-full pl-10 pr-8 py-3 bg-slate-50 border rounded-lg appearance-none outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">{managerList.length ? "Listeden SeÃ§iniz..." : "Ã–nce Dosya YÃ¼kleyin"}</option>
                                        {managerList.map((m, i) => <option key={i} value={m}>{m}</option>)}
                                    </select>
                                    <Search className="absolute left-3 top-3.5 text-slate-400 w-5 h-5" />
                                    <ChevronDown className="absolute right-3 top-3.5 text-slate-400 w-5 h-5" />
                                </div>
                                <div className="relative">
                                    <input type="text" value={targetPhone} onChange={saveTargetPhone} placeholder="Raporun GÃ¶nderileceÄŸi Numara (Opsiyonel)" className="w-full pl-10 pr-4 py-3 bg-slate-50 border rounded-lg outline-none focus:ring-2 focus:ring-green-500 text-sm"/>
                                    <PhoneIcon className="absolute left-3 top-3.5 text-slate-400 w-5 h-5" />
                                </div>
                                <p className="text-[10px] text-slate-400 mt-1 pl-1">Numara girerseniz "WhatsApp Listesi" butonu direkt o kiÅŸiye gÃ¶nderir.</p>
                                {managerList.length > 0 && !searchName && <p className="text-xs text-red-500 mt-2 font-bold animate-pulse">ðŸ‘† LÃ¼tfen isminizi seÃ§in!</p>}
                            </div>
                        </div>

                        {/* SONUÃ‡LAR */}
                        {processedData && Object.keys(processedData).length > 0 ? (
                            <div className="space-y-4 animate-fade-in">
                                {Object.entries(processedData).map(([whName, data]) => {
                                    const currentData = activeTab === 'orientation' ? data.orientation : data.chat;
                                    const expanded = expandedWarehouses[whName];
                                    const theme = activeTab === 'orientation' ? 'text-blue-700 bg-blue-50' : 'text-purple-700 bg-purple-50';
                                    
                                    const total = data.total;
                                    const incompleteCount = currentData.incomplete.length;
                                    const completedCount = total - incompleteCount;
                                    const completionRate = total > 0 ? Math.round((completedCount / total) * 100) : 0;
                                    let rateColor = "text-red-600";
                                    if (completionRate > 10 && completionRate <= 30) rateColor = "text-orange-500";
                                    else if (completionRate > 30 && completionRate <= 60) rateColor = "text-amber-500";
                                    else if (completionRate > 60 && completionRate <= 80) rateColor = "text-blue-600";
                                    else if (completionRate > 80) rateColor = "text-green-600";

                                    return (
                                        <div key={whName} className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                            <div onClick={() => toggleWarehouse(whName)} className="p-4 flex items-center justify-between cursor-pointer hover:bg-slate-50">
                                                <div className="flex items-center gap-3">
                                                    <div className={`p-2 rounded-lg ${theme}`}><Filter size={18} /></div>
                                                    <div>
                                                        <h3 className="font-bold text-slate-800 text-sm md:text-base">{whName}</h3>
                                                        <p className="text-xs text-slate-500">Eksik: <span className="font-bold text-red-600">{incompleteCount}</span> / {total}</p>
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-4">
                                                     <div className="text-right">
                                                        <span className={`block text-lg font-bold ${rateColor}`}>%{completionRate}</span>
                                                        <span className="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Tamamlanma</span>
                                                    </div>
                                                    {expanded ? <ChevronUp className="text-slate-400"/> : <ChevronDown className="text-slate-400"/>}
                                                </div>
                                            </div>

                                            {expanded && (
                                                <div className="border-t border-slate-100 bg-slate-50/50 p-4">
                                                    {/* Capture Area */}
                                                    <div ref={el => listRefs.current[whName] = el} className="bg-white p-4 md:p-6 rounded-lg border border-red-200 shadow-sm max-w-2xl mx-auto mb-4 relative overflow-hidden">
                                                        <div className="show-on-capture hidden absolute top-0 left-1/2 transform -translate-x-1/2 mt-4 w-32 z-20">
                                                            <GetirTextLogo />
                                                        </div>
                                                        <div className="show-on-capture hidden absolute top-0 left-0 w-full h-full z-0 opacity-10 pointer-events-none">
                                                             <SafetyGearPattern className="w-full h-full" />
                                                        </div>
                                                        <div className="mb-4 border-b border-red-100 pb-3 relative z-10 mt-12">
                                                            <div className="flex justify-between items-center"><h4 className="font-bold text-lg text-slate-800">{whName}</h4><span className="text-xs text-slate-500 date-label">{new Date().toLocaleDateString('tr-TR')}</span></div>
                                                            <h5 className={`font-semibold text-sm flex items-center gap-2 ${activeTab === 'orientation' ? 'text-blue-700' : 'text-purple-700'}`}><XCircle size={16} className="text-red-500"/> {activeTab === 'orientation' ? 'Oryantasyon EÄŸitimi' : 'Ã–ÄŸretici Sohbetler EÄŸitimi'}</h5>
                                                        </div>
                                                        <ul className="space-y-2 relative z-10">
                                                            {currentData.incomplete.map((c, i) => (
                                                                <li key={i} className="text-sm text-slate-700 bg-red-50 p-2 md:p-3 rounded flex justify-between items-center border border-red-100">
                                                                    <div className="flex items-center gap-2 w-full justify-center">
                                                                        <span className="font-semibold text-xs md:text-sm">{c['Courier Name']}</span>
                                                                        {c.isBlank && <div className="tooltip-container relative hide-on-capture"><AlertTriangle size={14} className="text-amber-500 cursor-help" /><div className="tooltip-text invisible absolute bottom-full left-1/2 -translate-x-1/2 mb-1 w-48 p-2 bg-slate-800 text-white text-[10px] rounded shadow-lg z-50 text-center">Entegrasyonu tamamlanmamÄ±ÅŸ kurye olabilir dikkat!</div></div>}
                                                                    </div>
                                                                    <a href={getWhatsappLink(c['Courier Gsm'], activeTab, c['Courier Name'])} target="_blank" className="text-green-600 bg-white px-2 py-1 rounded border border-green-200 text-xs font-mono flex items-center gap-1 no-underline ml-auto"><MessageSquare size={12}/> {c['Courier Gsm']}</a>
                                                                </li>
                                                            ))}
                                                            {currentData.incomplete.length === 0 && <li className="text-center py-4 text-green-600 bg-green-50 rounded font-medium text-sm">Herkes tamamladÄ±! ðŸŽ‰</li>}
                                                        </ul>
                                                        {activeTab === 'chat' && (
                                                            <div className="mt-6 pt-4 border-t-2 border-slate-100 text-xs text-slate-700 leading-relaxed relative z-10">
                                                                <p className="font-bold text-center text-sm text-purple-800 mb-2">ðŸš€ {currentMonth} AyÄ± Ã–ÄŸretici Sohbetler YayÄ±nda! ðŸš€</p>
                                                                <p className="mb-2">ðŸ“£ {currentMonth} AyÄ± Ã–ÄŸretici Sohbetler <span className="font-bold">"{chatSettings.name || 'EÄŸitim AdÄ±'}"</span> adlÄ± videoya aÅŸaÄŸÄ±daki linkten ulaÅŸabilirsiniz. GÃ¼venli sÃ¼rÃ¼ÅŸler.</p>
                                                                <p className="mb-4 text-blue-600 font-mono break-all font-bold">https://www.getirup.com/getirup/eep/main/activity/{chatSettings.id || 'EÄŸitim ID'}</p>
                                                                <p className="font-bold text-slate-800 mb-1 border-b border-slate-200 pb-1">GiriÅŸ YÃ¶ntemleri ðŸš¨</p>
                                                                <div className="space-y-2">
                                                                    <p>ðŸ“Ž <strong>E.mobil uygulamasÄ±</strong> telefonda yÃ¼klÃ¼ olmalÄ±. SonrasÄ±nda MDUâ€™ya giriÅŸ yapÄ±n ve profil bÃ¶lÃ¼mÃ¼nde Getirupâ€™Ä± tÄ±klayÄ±n. Åžifresiz giriÅŸ yapabilirsiniz.</p>
                                                                    <p className="font-bold text-center text-slate-400 text-[10px]">- YADA -</p>
                                                                    <p>ðŸ“Ž <strong>E.Mobil uygulamasÄ±na</strong> giriÅŸ yaparak ulaÅŸabilirsiniz.<br/><span className="font-semibold text-purple-700">Kurum Kodu:</span> GETIRUP<br/><span className="font-semibold text-purple-700">KullanÄ±cÄ± adÄ±:</span> Telefon numaranÄ±z (baÅŸÄ±nda 0 olmadan)<br/>ParolamÄ± unuttum diyerek yeni parola oluÅŸturabilirsiniz.</p>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                    
                                                    <div className="flex justify-center gap-2 flex-wrap">
                                                        <button onClick={() => handleShareText(whName)} className="bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-sm flex items-center gap-2 hover:bg-green-600 transition-colors"><MessageSquare size={16}/> {targetPhone ? 'KiÅŸiye GÃ¶nder' : 'WhatsApp Listesi'}</button>
                                                        <button onClick={() => handleShareImage(whName)} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-sm flex items-center gap-2 hover:bg-blue-700 transition-colors"><Copy size={16}/> <span className="hidden sm:inline">GÃ¶rsel Kopyala</span><span className="sm:hidden">GÃ¶rsel</span></button>
                                                        <button onClick={() => handleDownloadSingle(whName)} className="bg-white border border-slate-300 text-slate-600 px-3 py-2 rounded-lg shadow-sm hover:bg-slate-50 transition-colors"><Download size={16}/></button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                                
                                <div className="fixed bottom-6 left-0 right-0 flex justify-center pointer-events-none z-50">
                                    <div className="bg-white p-2 rounded-full shadow-lg border pointer-events-auto">
                                        <button onClick={downloadAll} disabled={downloadingAll} className="bg-slate-800 text-white px-6 py-3 rounded-full font-bold flex items-center gap-2 shadow-md">{downloadingAll ? <Loader className="animate-spin"/> : <Layers size={20}/>} TÃ¼mÃ¼nÃ¼ Ä°ndir</button>
                                    </div>
                                </div>
                            </div>
                        ) : null}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
